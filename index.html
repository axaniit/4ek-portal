<!-- ===== 4EK Ambassador Portal Login (NETLIFY REDIRECT VERSION) ===== -->
<meta name="robots" content="noindex, nofollow">

<style>
  .field{display:block;margin:8px 0;}
  .input{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;margin-top:6px;}
  .btn{width:100%;padding:12px;border:0;border-radius:10px;background:#111;color:#fff;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .hint{font-size:12px;color:#666;margin-top:6px;line-height:1.35}
  .hidden{display:none}
  a{color:#111}
</style>

<div id="box" style="max-width:460px;margin:24px auto;padding:18px;border:1px solid #e2e2e2;border-radius:12px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.06)">
  <h2 style="margin:0 0 6px;">4EK Ambassador Portal</h2>
  <p style="color:#666;margin:0 0 14px;">Login with UCF Email</p>

  <div id="msg" class="hint hidden" style="margin-bottom:12px;"></div>

  <form id="stepLogin">
    <label class="field">UCF Email
      <input id="email" type="email" class="input" placeholder="you@ucf.edu" required autocomplete="username">
    </label>
    <label class="field">Password
      <input id="password" type="password" class="input" autocomplete="current-password">
    </label>
    <button class="btn" id="btnLogin" type="submit">Continue</button>
  </form>
</div>

<script>
/* ===== CONFIG ===== */
const API = "https://script.google.com/macros/s/AKfycbxUUnLnZWfYGe0ZJ5NKtoLXa78qXCK-cEeCv2Ip_3Xm_XUDy-fFp-w0gShBxakcjJdCPg/exec";
const SESSION_KEY = "portal_session_v1";

/* ðŸ”¥ HARD-CODED NETLIFY DESTINATION */
const NETLIFY_BASE = "https://cool-tarsier-9bfafd.netlify.app";

/* ===== UTIL ===== */
const $ = (id) => document.getElementById(id);

function setMsg(t, ok=false){
  const el = $("msg");
  el.classList.remove("hidden");
  el.style.color = ok ? "#1a7f37" : "#b00020";
  el.textContent = t;
}
function hideMsg(){ $("msg").classList.add("hidden"); }

function saveSession(username, role){
  const payload = { username, role, ts: Date.now() };
  localStorage.setItem(SESSION_KEY, JSON.stringify(payload));
}

function redirectToPortal(role){
  const target = role === "admin"
    ? NETLIFY_BASE + "/admin.html"
    : NETLIFY_BASE + "/student.html";

  console.log("FORCING redirect to:", target);

  // HARD NAVIGATION â€” CANNOT resolve relative to WordPress
  window.location.href = target;
}

/* ===== API ===== */
async function POST_LOGIN(email, password){
  const qs = new URLSearchParams({
    action: "login",
    student_id: email,
    email: email,
    username: email
  }).toString();

  const url = API + "?" + qs;

  const r = await fetch(url, {
    method: "POST",
    mode: "cors",
    cache: "no-cache",
    body: JSON.stringify({
      student_id: email,
      email: email,
      username: email,
      password: password
    })
  });

  const t = await r.text();
  try { return JSON.parse(t); }
  catch { return { ok:false, error:"Invalid JSON", body:t }; }
}

/* ===== LOGIN ===== */
$("stepLogin").addEventListener("submit", async (e)=>{
  e.preventDefault();
  hideMsg();

  const email = ($("email").value || "").trim().toLowerCase();
  const password = $("password").value || "";

  if(!email){ setMsg("Enter your UCF email."); return; }
  if(!password){ setMsg("Enter your password."); return; }

  $("btnLogin").disabled = true;
  $("btnLogin").textContent = "Loadingâ€¦";

  try{
    localStorage.removeItem(SESSION_KEY);

    const out = await POST_LOGIN(email, password);
    console.log("LOGIN response:", out);

    if(out?.ok && out.role){
      saveSession(email, out.role);
      redirectToPortal(out.role);
      return;
    }

    if(out?.status === "bad_password"){
      setMsg("Incorrect password.");
    } else if(out?.error){
      setMsg("Login failed: " + out.error);
    } else {
      setMsg("Login failed.");
    }

  }catch(err){
    console.error("Login error:", err);
    setMsg("Could not reach login service.");
  }

  $("btnLogin").disabled = false;
  $("btnLogin").textContent = "Continue";
});
</script>

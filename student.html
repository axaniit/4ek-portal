<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Student Portal</title>
<meta name="robots" content="noindex, nofollow">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<style>
  :root { 
    --ucf-gold:#F4CA3D; 
    --ucf-black:#000; 
    --ucf-purple:#6A0DAD; 
    --ucf-red:#C1121F; 
    --portal-green: #2e7d32; 
  }

  body {
    margin: 0;
    padding: 0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: #fff;
    color: #333;
  }

  /* ========= HERO ========= */
  section.portal-hero{
    background:#F4CA3D !important;        
    background-image:none !important;     
    min-height:110px !important;          
    display:flex !important;
    align-items:center !important;
    justify-content:center !important;
    text-align:center !important;
    padding:0 !important;
    width: 100%;
    margin-bottom: 24px;
  }

  section.portal-hero h1{
    font-family:"Montserrat", sans-serif !important;
    font-size:44px !important;
    font-weight:700 !important;
    margin:0 !important;
    color:#111 !important;
  }

  .portal-accent-line{
    height:6px !important;
    background:#F4CA3D !important;
    margin-top: -24px; 
    margin-bottom: 24px;
  }

  /* Main Container */
  #student-app { 
    max-width:1100px; 
    margin: 0 auto; 
    padding: 0 16px 40px 16px;
  }

  /* Calendar Container */
  #calendar { 
    min-height: 640px; 
    position: relative; 
  }
  #calendar * { font-family: inherit; }

  /* Header Stats */
  .amb-top{display:flex;justify-content:space-between;align-items:flex-end;margin:8px 0 16px}
  .muted{color:#666}.small{font-size:12px}.h-name{font-weight:600;font-size:18px}
  .h-big{font-size:40px;font-weight:700;margin-top:4px}
  .hours{text-align:right}

  /* Grid Layout */
  .amb-grid{
    display:grid;
    gap:16px;
    margin:0 0 16px;
    align-items: stretch;
  }
  @media (min-width: 980px){ 
    .amb-grid{ grid-template-columns: 1fr 1fr; } 
  }

  .card{
    border:1px solid #e5e5e5;
    border-radius:12px;
    box-shadow:0 4px 14px rgba(0,0,0,.04);
    overflow:hidden;
    background:#fff;
    margin:12px 0;
    display: flex;
    flex-direction: column;
    height: 100%; 
  }
  .card-h{padding:12px 16px;border-bottom:1px solid #eee;font-weight:600}
  .card-b{ 
    padding:16px; 
    flex: 1; 
  }

  /* Requirements List - GREEN CHECKMARKS */
  .req-list{list-style:none;margin:0;padding:0}
  .req-list li{display:flex;gap:8px;margin:8px 0;align-items:center}
  
  .req-list .box{
    width:18px;height:18px;
    border:2px solid #ccc;
    border-radius:4px;
    display:inline-flex;align-items:center;justify-content:center;
    font-size:14px;line-height:1;
    color: transparent;
    background:transparent;
    font-weight: 700;
    transition: all 0.2s;
  }
  
  .req-list .box.done {
    border-color: var(--portal-green);
    color: var(--portal-green);
    background: rgba(46, 125, 50, 0.1);
  }

  /* Forms */
  .form h4 { margin:.25rem 0 .5rem; font-size: 20px; font-weight: 700; }
  .form label{display:block;margin:8px 0}
  .form select, .form input, .form textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px; font-family: inherit; box-sizing: border-box;}

  /* MAIN BUTTONS */
  .form button, #btnReq, #btnSignup, .primary {
    margin-top:6px;
    padding:12px 16px;
    border:0;
    background:#111;
    color:#fff;
    border-radius:8px;
    cursor:pointer;
    font-family: inherit;
    font-size: 13px; 
    font-weight: 700;
    text-transform: uppercase; 
    letter-spacing: 0.5px;
  }
  .form button:hover, .primary:hover {opacity:.9}
  .form button:disabled {opacity:.6;cursor:not-allowed}

  /* HISTORY REFRESH */
  #btnMeRefresh {
    padding: 6px 10px !important;
    font-size: 12px !important;
    font-weight: 400 !important;
    background: #fff !important;
    border: 1px solid #ddd !important;
    color: #333 !important;
    border-radius: 8px;
    cursor: pointer;
    margin: 0;
    text-transform: none;
  }
  #btnMeRefresh:hover { background: #fafafa !important; }

  /* Secondary Button */
  .secondary{padding:10px 14px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
  .secondary:hover{background:#fafafa}

  .msg{margin-top:8px;font-size:13px}.ok{color:#1a7f37}.err{color:#b00020}

  /* History Table */
  .hist-top{display:grid;gap:10px}
  @media (min-width: 900px){ .hist-top{ grid-template-columns: 1fr 1fr 1fr; } }
  .hist-card{border:1px solid #eee;border-radius:12px;padding:12px;background:#fafafa}
  .hist-big{font-size:28px;font-weight:700;margin-top:4px}
  
  .hist-table{width:100%;border-collapse:collapse}
  .hist-table th,.hist-table td{border-bottom:1px solid #eee;padding:10px 8px;text-align:left;vertical-align:middle}
  .hist-table th{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:.02em}
  
  /* Zebra Striping */
  .hist-table tbody tr:nth-child(odd) { background: #fff; }
  .hist-table tbody tr:nth-child(even) { background: #f9f9f9; }

  .tag{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px;color:#444;background:#fff}

  /* Emoji Badge */
  .emoji-bg { 
    background: #fff; 
    border-radius: 50%; 
    padding: 4px; 
    width: 24px; height: 24px;
    display: inline-flex;
    align-items: center; justify-content: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15); 
  }

  .hist-scroll{
    max-height: 320px;
    overflow-y: auto;
    overflow-x: auto;
    border: 1px solid #eee;
    border-radius: 12px;
  }
  .hist-scroll::-webkit-scrollbar{ width: 10px; height: 10px; }
  .hist-scroll::-webkit-scrollbar-thumb{ background: rgba(0,0,0,.22); border-radius: 999px; }
  .hist-scroll::-webkit-scrollbar-track{ background: rgba(0,0,0,.05); border-radius: 999px; }

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999}
  .modal-dialog{width:min(820px,100%);background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.2)}
  .modal-h{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #eee}
  .modal-b{padding:16px;min-height:140px}
  .modal-f{padding:12px 16px;border-top:1px solid #eee;text-align:right;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
  .modal .x{background:transparent;border:0;font-size:22px;cursor:pointer}
  .rosters{display:grid;gap:16px;margin-top:12px}
  .roster{margin:.25rem 0 0;padding-left:18px}
  .cap{margin:8px 0 0;font-weight:600}

  /* FullCalendar overrides */
  .fc, .fc * { pointer-events:auto; }
  .fc-event, .fc-event * { pointer-events:auto !important; }
  .fc .fc-toolbar{
    background:#fff;
    border:1px solid #eee;
    border-radius:12px;
    padding:10px 12px;
    margin-bottom:12px;
  }
  .fc .fc-toolbar-title{ font-weight:700; color: #111; }
  .fc .fc-button{
    background:#fff !important;
    border:1px solid #ddd !important;
    color:#111 !important;
    box-shadow:none !important;
    text-transform:none !important;
    opacity:1 !important;
  }
  .fc .fc-button:hover{ background:#f7f7f7 !important; }
  .fc .fc-button:disabled{ opacity:.55 !important; }
  .fc .fc-button-primary:not(:disabled).fc-button-active,
  .fc .fc-button-primary:not(:disabled):active{
    background: rgba(244,202,61,.15) !important;
    border-color: rgba(244,202,61,.45) !important;
    color:#111 !important;
  }

  .fc-event{ background: transparent !important; border-color: transparent !important; }
  .fc-list-event:hover td{ background: rgba(0,0,0,.03) !important; }

  /* Categories */
  .cat-gold .fc-daygrid-event-dot, .cat-gold .fc-list-event-dot { border-color:var(--ucf-gold); background:var(--ucf-gold); }
  .cat-black .fc-daygrid-event-dot, .cat-black .fc-list-event-dot { border-color:var(--ucf-black); background:var(--ucf-black); }
  .cat-purple .fc-daygrid-event-dot, .cat-purple .fc-list-event-dot { border-color:var(--ucf-purple); background:var(--ucf-purple); }
  .cat-red .fc-daygrid-event-dot, .cat-red .fc-list-event-dot { border-color:var(--ucf-red); background:var(--ucf-red); }

  .fc-timegrid-event.cat-gold  { border-left: 4px solid var(--ucf-gold); }
  .fc-timegrid-event.cat-black { border-left: 4px solid var(--ucf-black); }
  .fc-timegrid-event.cat-purple{ border-left: 4px solid var(--ucf-purple); }
  .fc-timegrid-event.cat-red   { border-left: 4px solid var(--ucf-red); }

  /* Confetti */
  #confettiModal{ z-index:10002; }
</style>
</head>
<body>

  <section class="portal-hero">
    <h1>4EK Ambassador Portal</h1>
  </section>
  <div class="portal-accent-line"></div>

<div id="student-app">
  <header class="amb-top">
    <div>
      <div class="muted" id="ambGreet">Welcome</div>
      <div class="h-name" id="ambName">‚Äî</div>
    </div>
    <div class="hours">
      <div class="muted" id="hoursLabel">My Semester Total Hours</div>
      <div class="h-big" id="hoursTotal">0</div>
      <div class="muted small" id="hoursSub" style="margin-top:2px;">Spring2026</div>
    </div>
  </header>

  <section class="amb-grid">
    <div class="card">
      <div class="card-h">Your Requirements</div>
      <div class="card-b">
        <ul id="reqList" class="req-list"></ul>
        <div class="muted small" style="margin-top: 12px;">Admins control these checkboxes.</div>
      </div>
    </div>

    <div class="card">
      <div class="card-h">Quick Actions</div>
      <div class="card-b">
        <form id="formRequest" class="form" autocomplete="off">
          <h4>Attendance Request</h4>
          <label>Choose event
            <select id="reqEvent"></select>
          </label>

          <label id="reqShiftWrap" style="display:none;">Shift
            <select id="reqShift"></select>
            <div class="muted small" id="reqShiftHint" style="margin-top:6px;"></div>
          </label>

          <div class="grid2" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <label>Requested hours (optional)
              <input id="reqHours" type="number" step="0.25" min="0" placeholder="e.g. 2.5">
            </label>
            <div class="muted small" style="display:flex;align-items:center;">
              If blank, it will use the event‚Äôs hours.
            </div>
          </div>
          <label>Comment (times you‚Äôre available / notes etc.)
            <textarea id="reqComment" rows="2" placeholder="I can work 2‚Äì4pm because ‚Ä¶"
              style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;"></textarea>
          </label>
          <button id="btnReq" type="submit">Submit Request</button>
          <div class="msg" id="msgReq"></div>
        </form>

        <hr style="margin:16px 0;border:none;border-top:1px solid #eee;">

        <form id="formSignup" class="form" autocomplete="off">
          <h4>Event Sign-Up</h4>
          <label>Choose event
            <select id="signupEvent"></select>
          </label>

          <label id="suShiftWrap" style="display:none;">Shift
            <select id="suShift"></select>
            <div class="muted small" id="suShiftHint" style="margin-top:6px;"></div>
          </label>

          <div class="grid2" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <label>Requested hours (optional)
              <input id="suHours" type="number" step="0.25" min="0" placeholder="e.g. 2.5">
            </label>
            <div class="muted small" style="display:flex;align-items:center;">
              If blank, it will use the event‚Äôs hours.
            </div>
          </div>
          <label>Comment (times you‚Äôre available / notes etc.)
            <textarea id="suComment" rows="2" placeholder="I‚Äôm available after class at 3:30‚Ä¶"
              style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;"></textarea>
          </label>
          <button id="btnSignup" type="submit">Sign Up</button>
          <div class="msg" id="msgSignup"></div>
        </form>
      </div>
    </div>
  </section>

  <div class="card">
    <div class="card-h" style="display:flex;justify-content:space-between;align-items:center;">
      <span>History</span>
      <button id="btnMeRefresh" type="button" onclick="loadHistory()">Refresh</button>
    </div>
    <div class="card-b">
      <div class="muted small" style="margin-bottom:10px;">
        This shows your <b>requests</b> and your <b>approved attendance</b>. Totals only include approved attendance hours.
      </div>

      <div class="hist-top">
        <div class="hist-card">
          <div class="muted small">Semester</div>
          <select id="histSem" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;"></select>
        </div>
        <div class="hist-card">
          <div class="muted small">Semester Total (approved)</div>
          <div class="hist-big" id="histSemTotal">0</div>
        </div>
        <div class="hist-card">
          <div class="muted small">All-Time Total (approved)</div>
          <div class="hist-big" id="histAllTotal">0</div>
        </div>
      </div>

      <div class="hist-scroll" style="margin-top:12px;">
        <table class="hist-table">
          <thead>
            <tr>
              <th style="min-width:140px;">Semester</th>
              <th style="min-width:220px;">Event</th>
              <th style="min-width:160px;">Date</th>
              <th style="min-width:90px;">Hours</th>
              <th style="min-width:90px;">Status</th>
              <th style="min-width:260px;">Comments</th>
            </tr>
          </thead>
          <tbody id="histRows">
            <tr><td colspan="6" class="muted small">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

      <div class="msg" id="msgHist" style="margin-top:10px;"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-h">Calendar</div>
    <div class="card-b">
      <div id="calendar">
        <div style="padding:20px; color:#666; text-align:center;">Loading Calendar...</div>
      </div>
    </div>
  </div>
</div>

<div id="eventModal" class="modal" style="display:none;">
  <div class="modal-dialog">
    <div class="modal-h">
      <div id="mTitle">Event</div>
      <button class="x" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-b">
      <div id="mWhen"></div>
      <div id="mWhere" class="muted"></div>
      <div id="mDesc" class="muted"></div>
      <div id="mCap" class="cap"></div>

      <div id="mShiftWrap" style="display:none; margin-top:12px; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid #ddd;">
        <div class="muted small" style="margin-bottom:6px;">This event uses shifts:</div>
        <label style="margin:0;">Shift
          <select id="mShift" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;margin-top:4px;"></select>
        </label>
        <div class="muted small" id="mShiftHint" style="margin-top:6px;"></div>
      </div>

      <div class="rosters">
        <div>
          <h5>Sign-ups</h5>
          <div class="muted small">Sign-ups don‚Äôt affect hours.</div>
          <ul id="mSignups" class="roster"></ul>

          <h6 class="muted" id="waitHdr" style="display:none;margin-top:8px;">Waitlist</h6>
          <ul id="mWait" class="roster"></ul>
        </div>
      </div>
    </div>
    <div class="modal-f">
      <button class="secondary" onclick="modalRequestAttendance()">Request attendance</button>
      <button class="primary" onclick="modalSignup()">Sign up</button>
      <button class="secondary" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>

<div id="confettiOverlay" style="display:none;position:fixed;inset:0;pointer-events:none;z-index:10001;">
  <canvas id="confettiCanvas" style="position:absolute;inset:0;width:100%;height:100%;"></canvas>
</div>

<div id="confettiModal" class="modal" style="display:none;">
  <div class="modal-dialog" style="width:min(560px,100%);position:relative;">
    <div class="modal-h">
      <div id="cTitle">Success üéâ</div>
      <button class="x" onclick="closeConfetti()">√ó</button>
    </div>
    <div class="modal-b" style="position:relative;">
      <div id="cBody" style="position:relative;">
        Your request was submitted.
      </div>
    </div>
    <div class="modal-f">
      <button class="secondary" onclick="closeConfetti()">Close</button>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API = "https://script.google.com/macros/s/AKfycbxUUnLnZWfYGe0ZJ5NKtoLXa78qXCK-cEeCv2Ip_3Xm_XUDy-fFp-w0gShBxakcjJdCPg/exec";
const SESSION_KEY = "portal_session_v1";
const CURRENT_SEMESTER = "Spring2026";

const REQUIREMENT_LABELS = {
  "2 Tailgates": "2 Tailgates",
  "2 Regalia Shifts": "2 Regalia Shifts (spring)",
  "1 Homecoming event": "1 Homecoming event",
  "1 Recruitment event": "1 Recruitment event",
  "Student Philanthropy Celebration": "Student Philanthropy Celebration",
  "Day of Giving": "Day of Giving",
  "2 Socials": "2 Socials (spring)",
  "Fall Retreat or Makeup": "Fall Retreat or Makeup",
  "30 Hours (spring)": "30 Hours (spring)"
};

/* ===== UTIL ===== */
function _norm(v){ return String(v == null ? "" : v).trim().toLowerCase(); }

function getSession(){
  try { return JSON.parse(localStorage.getItem(SESSION_KEY) || "{}"); }
  catch(e){ return {}; }
}
function toast(el, ok, msg){
  el.className = "msg " + (ok ? "ok" : "err");
  el.textContent = msg;
}

async function GET(q){
  const r = await fetch(API + "?" + new URLSearchParams(q), { mode:"cors", cache:"no-cache", redirect:"follow" });
  const t = await r.text();
  try { return JSON.parse(t); } catch { return { ok:false, error:"Non-JSON response", body:t }; }
}
async function POST(action, payload){
  const body = Object.assign({ action }, payload || {});
  const r = await fetch(API + "?action=" + encodeURIComponent(action), {
    method:"POST",
    mode:"cors",
    redirect:"follow",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(body)
  });
  const t = await r.text();
  try { return JSON.parse(t); } catch { return { ok:false, error:"Non-JSON response", body:t }; }
}

function fmtDate(dt){
  try{
    const d = new Date(dt);
    return d.toLocaleString([], { weekday:"short", month:"short", day:"numeric", hour:"numeric", minute:"2-digit" });
  }catch(_){ return String(dt); }
}
function fmtShortDate(dt){
  try{
    const d = new Date(dt);
    return d.toLocaleDateString([], { year:"numeric", month:"short", day:"numeric" });
  }catch(_){ return String(dt); }
}
function safeHours(val){
  const s = String(val ?? "").trim();
  if (!s) return null;
  const n = Number(s);
  if (!isFinite(n) || n < 0) return null;
  return n;
}
function titleCaseNameFromEmail(email){
  const base = String(email || "").split("@")[0].replace(/[._-]+/g, " ").trim();
  if (!base) return "Student";
  return base.split(" ").map(w => w ? (w[0].toUpperCase() + w.slice(1)) : "").join(" ");
}
function greetingForNow(){
  const h = new Date().getHours();
  if (h >= 5 && h < 12) return "Good Morning";
  if (h >= 12 && h < 17) return "Good Afternoon";
  if (h >= 17 && h < 22) return "Good Evening";
  return "Don‚Äôt Stay Up Too Late";
}

let _studentsCache = null;
async function getStudentsCached(){
  if (_studentsCache) return _studentsCache;
  const resp = await GET({ action:"students" });
  const list = Array.isArray(resp) ? resp : (resp && Array.isArray(resp.rows) ? resp.rows : (resp && Array.isArray(resp.students) ? resp.students : []));
  _studentsCache = list;
  return list;
}
function pickBestName(stu, fallbackEmail){
  if (!stu) return titleCaseNameFromEmail(fallbackEmail);
  const cand =
    stu.name ||
    stu.full_name || stu.fullName ||
    stu.display_name || stu.displayName ||
    (stu.first_name || stu.firstName || stu.firstname ? `${stu.first_name||stu.firstName||stu.firstname} ${stu.last_name||stu.lastName||stu.lastname||""}`.trim() : "") ||
    "";
  return String(cand || "").trim() || titleCaseNameFromEmail(fallbackEmail);
}
async function resolveStudentName(studentIdOrEmail){
  const id = _norm(studentIdOrEmail);
  const students = await getStudentsCached();
  const match = students.find(s => _norm(s.email) === id || _norm(s.student_id) === id);
  return pickBestName(match, studentIdOrEmail);
}

function catClass(cat){
  const c = String(cat || "").toLowerCase();
  if (c.startsWith("social"))   return "cat-gold";
  if (c.startsWith("event"))    return "cat-black";
  if (c.startsWith("meeting"))  return "cat-purple";
  if (c.startsWith("deadline")) return "cat-red";
  return "cat-gold";
}
function isActiveEvent(ev){
  const a = ev?.active;
  const s = ev?.status;
  const v = (a != null) ? a : s;
  if (typeof v === "boolean") return v === true;
  return String(v || "").toLowerCase() === "true";
}

function eventById(eventId){
  const id = String(eventId || "").trim();
  if (!id) return null;
  return (eventsCache || []).find(e => String(e.event_id) === id) || null;
}
function extractEventHours(ev){
  if (!ev) return 0;
  const candidates = [ev.hours, ev.event_hours, ev.default_hours, ev.hours_default, ev.duration_hours, ev.durationHours, ev.shift_hours];
  for (const c of candidates){
    const n = Number(c);
    if (isFinite(n) && n > 0) return n;
  }
  const start = Date.parse(ev.start);
  const end   = Date.parse(ev.end);
  if (!isNaN(start) && !isNaN(end) && end > start){
    const hrs = (end - start) / 3600000;
    if (isFinite(hrs) && hrs > 0) return Math.round(hrs * 100) / 100;
  }
  return 0;
}
function requestedHoursOrEventDefault(rawInput, eventId){
  const n = safeHours(rawInput);
  if (n != null) return n;
  const ev = eventById(eventId);
  const def = extractEventHours(ev);
  return def > 0 ? def : 0;
}
function eventLabelFromSelect(sel){
  return sel?.options?.[sel.selectedIndex]?.textContent || "";
}

function cleanSemesterLabel(x){ return String(x || "").trim() || "Unknown"; }
function hoursNum(v){ const n = Number(v); return isFinite(n) ? n : 0; }
function toastHist(ok, msg){
  const el = document.getElementById("msgHist");
  if (!el) return;
  el.className = "msg " + (ok ? "ok" : "err");
  el.textContent = msg || "";
}

function normalizeAttendanceList(resp){
  if (Array.isArray(resp)) return resp;
  if (resp && Array.isArray(resp.rows)) return resp.rows;
  if (resp && Array.isArray(resp.attendance)) return resp.attendance;
  return [];
}
function normalizeRequestsList(resp){
  if (Array.isArray(resp)) return resp;
  if (resp && Array.isArray(resp.rows)) return resp.rows;
  if (resp && Array.isArray(resp.requests)) return resp.requests;
  if (resp && Array.isArray(resp.history)) return resp.history;
  return [];
}

function normalizeStatus(raw){
  const s = String(raw ?? "").trim().toLowerCase();
  if (!s) return "";
  if (s.includes("pend")) return "pending";
  if (s.includes("deny") || s.includes("reject") || s.includes("declin")) return "denied";
  if (s.includes("approv") || s.includes("accept") || s.includes("ok") || s.includes("enter")) return "approved";
  return s;
}
function statusIconForRow(row){
  if (row?._type === "attendance") return "‚úÖ";
  const s = normalizeStatus(row.status || row.request_status || row.decision || row.state);
  if (s === "pending") return "‚ö†Ô∏è";
  if (s === "denied") return "‚ùå";
  if (s === "approved") return "‚úÖ";
  return "‚ö†Ô∏è";
}
function rowDateKey(row){
  const t = row.event_start || row.start || row.recorded_at || row.created_at || row.requested_at || row.timestamp || "";
  const ms = Date.parse(t);
  return isNaN(ms) ? 0 : ms;
}
function rowSemester(row){
  return cleanSemesterLabel(row.semester_id || row.semester || row.semesterId || row.sem || "");
}
function rowEventId(row){
  return String(row.event_id || row.eventId || row.event || "").trim();
}
function rowEventTitle(row){
  const direct = String(row.event_title || row.title || row.event_name || row.eventName || "").trim();
  let base = direct;
  if (!base) {
    const id = rowEventId(row);
    const ev = eventById(id);
    base = String(ev?.title || id || "‚Äî");
  }
  return base;
}
function rowEventDateForDisplay(row){
  const dt = row.event_start || row.start || row.recorded_at || row.created_at || row.requested_at || "";
  return dt ? fmtShortDate(dt) : "‚Äî";
}
function rowHoursForDisplay(row){
  if (row?._type === "attendance"){ return hoursNum(row.hours_awarded); }
  const rh = row.requested_hours ?? row.hours_requested ?? row.hours ?? row.req_hours;
  return hoursNum(rh);
}
function rowComment(row){
  return String(row.comments || row.comment || row.notes || "").trim();
}

function getRowStudentToken(row){
  const candidates = [
    row?.student_id, row?.studentId, row?.student, row?.username,
    row?.email, row?.student_email, row?.studentEmail, row?.student_email_address,
    row?.ambassador_email, row?.ambassador, row?.user, row?.user_id, row?.userId
  ];
  for (const c of candidates){ const n = _norm(c); if (n) return n; }
  return ""; 
}
function belongsToCurrentStudent(row, studentId){
  const me = _norm(studentId);
  if (!me) return false;
  const token = getRowStudentToken(row);
  if (token) return token === me;
  return true;
}

/* ===== SHIFTS INTEGRATION ===== */
const shiftsCacheByEvent = new Map();
const shiftMapById = new Map();
const shiftLabelById = new Map();

function isTrue(v) {
  if (typeof v === "boolean") return v === true;
  const s = String(v ?? "").trim().toLowerCase();
  return s === "true" || s === "yes" || s === "1";
}

function shiftLabel(s){
  if (!s) return "";
  const title = s.shift_title || s.shiftTitle || s.title || s.name || "Shift";
  const start = s.start || s.shift_start || s.start_local;
  const end   = s.end   || s.shift_end   || s.end_local;
  
  if (!start) return title;
  
  try{
    const d1 = new Date(start);
    const d2 = end ? new Date(end) : null;
    const t1 = d1.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"});
    const t2 = d2 ? d2.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"}) : "";
    return `${title} (${t1}${t2 ? "‚Äì"+t2 : ""})`;
  } catch(_){ return title; }
}

function normalizeShiftsResp(resp){
  if (!resp) return [];
  if (Array.isArray(resp)) return resp;
  if (Array.isArray(resp.shifts)) return resp.shifts;
  if (Array.isArray(resp.rows)) return resp.rows;
  if (Array.isArray(resp.data)) return resp.data;
  if (resp.data && Array.isArray(resp.data.shifts)) return resp.data.shifts;
  if (resp.result && Array.isArray(resp.result.shifts)) return resp.result.shifts;
  return [];
}

function shiftsFromEventObject(eventId){
  const ev = eventById(eventId);
  if (!ev) return [];

  let raw = ev.shifts ?? ev.shift_list ?? ev.shiftList ?? ev.shifts_data ?? ev.shiftsData ?? null;
  if (!raw && typeof ev.shifts_json === "string") raw = ev.shifts_json;
  if (!raw && typeof ev.shiftsJson === "string") raw = ev.shiftsJson;

  if (typeof raw === "string"){
    const s = raw.trim();
    if (!s) return [];
    try { raw = JSON.parse(s); } catch(_) { return []; }
  }

  if (!Array.isArray(raw)) return [];

  return raw.map((s, i)=>({
    ...s,
    shift_id: String(s.shift_id ?? s.shiftId ?? s.id ?? `${eventId}_shift_${i+1}`).trim(),
    event_id: String(s.event_id ?? s.eventId ?? eventId).trim()
  })).filter(s=>s.shift_id);
}

async function loadShiftsForEvent(eventId){
  const evId = String(eventId || "").trim();
  if (!evId) return [];

  if (shiftsCacheByEvent.has(evId)) return shiftsCacheByEvent.get(evId) || [];

  const resp = await GET({ action:"shifts", event_id: evId });
  let list = normalizeShiftsResp(resp);

  if (!list || !list.length){
    list = shiftsFromEventObject(evId);
  }

  const cleaned = (list || []).map(s => {
    const sid = String(s.shift_id ?? s.shiftId ?? s.id ?? "").trim();
    return { ...s, shift_id: sid, event_id: String(s.event_id ?? s.eventId ?? evId).trim() };
  }).filter(s => s.shift_id);

  shiftsCacheByEvent.set(evId, cleaned);

  cleaned.forEach(s=>{
    shiftMapById.set(s.shift_id, s);
    shiftLabelById.set(s.shift_id, shiftLabel(s));
  });

  return cleaned;
}

function mustPickShiftForEvent(eventId){
  const ev = eventById(eventId);
  return isTrue(ev?.shifts_required) === true;
}

async function setShiftUI(prefix, eventId){
  const wrap = document.getElementById(prefix + "ShiftWrap");
  const sel  = document.getElementById(prefix + "Shift");
  const hint = document.getElementById(prefix + "ShiftHint");
  if (!wrap || !sel) return;

  sel.innerHTML = "";
  if (hint) hint.textContent = "";

  const evId = String(eventId || "").trim();
  if (!evId){
    wrap.style.display = "none";
    return;
  }

  const shifts = await loadShiftsForEvent(evId);

  if (!shifts.length){
    wrap.style.display = "none";
    return;
  }

  wrap.style.display = "block";

  const required = mustPickShiftForEvent(evId);
  if (required){
    sel.appendChild(new Option("Select a shift‚Ä¶", ""));
  } else {
    sel.appendChild(new Option("No shift (not required)", ""));
  }

  shifts.forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s.shift_id;
    opt.textContent = shiftLabelById.get(s.shift_id) || shiftLabel(s);
    sel.appendChild(opt);
  });

  if (hint){
    hint.textContent = required
      ? "Shift selection is required for this event."
      : "Optional ‚Äî pick a shift if you want your sign-up/request tied to a specific shift.";
  }
}

async function setModalShiftUI(eventId){
  const wrap = document.getElementById("mShiftWrap");
  const sel  = document.getElementById("mShift");
  const hint = document.getElementById("mShiftHint");
  if (!wrap || !sel) return;

  sel.innerHTML = "";
  if (hint) hint.textContent = "";

  const evId = String(eventId || "").trim();
  if (!evId){
    wrap.style.display = "none";
    return;
  }

  const shifts = await loadShiftsForEvent(evId);

  if (!shifts.length){
    wrap.style.display = "none";
    return;
  }

  wrap.style.display = "block";
  const required = mustPickShiftForEvent(evId);

  if (required){
    sel.appendChild(new Option("Select a shift‚Ä¶", ""));
  } else {
    sel.appendChild(new Option("No shift (not required)", ""));
  }

  shifts.forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s.shift_id;
    opt.textContent = shiftLabelById.get(s.shift_id) || shiftLabel(s);
    sel.appendChild(opt);
  });

  if (hint){
    hint.textContent = required
      ? "Shift selection is required for this event."
      : "Optional ‚Äî pick a shift if you want this tied to a shift.";
  }
}

function getSelectedShift(prefix){
  const wrap = document.getElementById(prefix + "ShiftWrap");
  const sel  = document.getElementById(prefix + "Shift");
  if (!wrap || !sel || wrap.style.display === "none") return null;
  const v = String(sel.value || "").trim();
  return v || null;
}

function modalSelectedShift(){
  const wrap = document.getElementById("mShiftWrap");
  const sel  = document.getElementById("mShift");
  if (!wrap || !sel || wrap.style.display === "none") return null;
  const v = String(sel.value || "").trim();
  return v || null;
}


/* ===== CONFETTI ===== */
let _confettiRAF = null;
let _confettiPieces = [];
let _confettiCtx = null;
let _confettiCanvas = null;
let _confettiOverlay = null;

function openConfetti(title, body){
  document.getElementById("cTitle").textContent = title || "Success üéâ";
  document.getElementById("cBody").innerHTML = body || "Done.";
  document.getElementById("confettiModal").style.display = "flex";
  startConfetti();
}
function closeConfetti(){ document.getElementById("confettiModal").style.display = "none"; }
function stopConfetti(){
  if (_confettiRAF) cancelAnimationFrame(_confettiRAF);
  _confettiRAF = null;
  _confettiPieces = [];
  if (_confettiCtx && _confettiCanvas){ try { _confettiCtx.clearRect(0,0,_confettiCanvas.width,_confettiCanvas.height); } catch(_){} }
  if (_confettiOverlay) _confettiOverlay.style.display = "none";
}
function startConfetti(){
  _confettiOverlay = document.getElementById("confettiOverlay");
  _confettiCanvas = document.getElementById("confettiCanvas");
  if (!_confettiOverlay || !_confettiCanvas) return;
  _confettiOverlay.style.display = "block";
  _confettiCtx = _confettiCanvas.getContext("2d");
  const colors = ["#ff4d6d","#ffb703","#8ecae6","#219ebc","#8338ec","#3a86ff","#06d6a0","#ffd166","#ef476f","#f72585","#4cc9f0","#b5179e"];
  const resize = () => {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = Math.floor(window.innerWidth * dpr);
    const h = Math.floor(window.innerHeight * dpr);
    if (_confettiCanvas.width !== w || _confettiCanvas.height !== h){ _confettiCanvas.width = w; _confettiCanvas.height = h; }
    _confettiCtx.setTransform(dpr,0,0,dpr,0,0);
  };
  resize();
  _confettiPieces = [];
  for (let i=0;i<260;i++){
    const size = 3 + Math.random() * 7;
    _confettiPieces.push({
      x: Math.random() * window.innerWidth, y: -60 - Math.random() * window.innerHeight * 0.9,
      w: size * (0.8 + Math.random()*0.8), h: size * (0.8 + Math.random()*1.4),
      vy: 2.2 + Math.random() * 5.8, vx: -1.8 + Math.random() * 3.6,
      rot: Math.random() * Math.PI, vr: -0.18 + Math.random() * 0.36,
      wob: Math.random() * Math.PI * 2, wobSpd: 0.02 + Math.random() * 0.06,
      color: colors[Math.floor(Math.random()*colors.length)], alpha: 0.95
    });
  }
  const startAt = performance.now();
  const loop = (now) => {
    resize();
    const w = window.innerWidth; const h = window.innerHeight;
    _confettiCtx.clearRect(0,0,w,h);
    let stillVisible = false;
    for (const p of _confettiPieces){
      p.wob += p.wobSpd; p.x += p.vx + Math.sin(p.wob) * 0.9; p.y += p.vy; p.rot += p.vr; p.vx *= 0.995;
      if (p.y < h + 80) stillVisible = true;
      _confettiCtx.save();
      _confettiCtx.translate(p.x, p.y);
      _confettiCtx.rotate(p.rot);
      _confettiCtx.globalAlpha = p.alpha;
      _confettiCtx.fillStyle = p.color;
      _confettiCtx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      _confettiCtx.restore();
    }
    const elapsed = now - startAt;
    if (elapsed > 5500 * 0.75){
      const t = (elapsed - 5500 * 0.75) / (5500 * 0.25);
      for (const p of _confettiPieces) p.alpha = 0.95 * Math.max(0, 1 - t);
    }
    if (!stillVisible || elapsed >= 5500 || _confettiOverlay.style.display !== "block"){ stopConfetti(); return; }
    _confettiRAF = requestAnimationFrame(loop);
  };
  if (_confettiRAF) cancelAnimationFrame(_confettiRAF);
  _confettiRAF = requestAnimationFrame(loop);
  window.addEventListener("resize", resize, { passive:true });
}

/* ===== STATE & BOOT ===== */
let currentStudentId = null;
let eventsCache = [];
let calendarInstance = null;
let _attendanceCache = [];
let _requestsCache = [];
let _fullHistoryCache = [];
let _modalEventId = null;

function extractSignupsAccepted(roster){
  if (!roster) return [];
  if (roster.signups && Array.isArray(roster.signups.accepted)) return roster.signups.accepted;
  if (roster.signups && Array.isArray(roster.signups)) return roster.signups;
  if (Array.isArray(roster.accepted)) return roster.accepted;
  if (Array.isArray(roster.rows)) return roster.rows;
  return [];
}
function extractSignupsWait(roster){
  if (!roster) return [];
  if (roster.signups && Array.isArray(roster.signups.waitlisted)) return roster.signups.waitlisted;
  if (roster.signups && Array.isArray(roster.signups.waitlist)) return roster.signups.waitlist;
  if (Array.isArray(roster.waitlisted)) return roster.waitlisted;
  return [];
}

function initCalendarSafe(events){
  let attempts = 0;
  const maxAttempts = 100;
  
  const poller = setInterval(() => {
    if (window.FullCalendar && window.FullCalendar.Calendar) {
      clearInterval(poller);
      buildCalendar(events);
    } else {
      attempts++;
      if (attempts > maxAttempts) {
        clearInterval(poller);
        const el = document.getElementById("calendar");
        if(el) el.innerHTML = `<div style="padding:20px;color:#b00020;text-align:center;">Calendar library failed to load.<br>Please refresh the page.</div>`;
      }
    }
  }, 100);
}

function buildCalendar(events){
  const el = document.getElementById("calendar");
  if (!el) return;

  el.innerHTML = ""; 

  const fcEvents = (events || []).map(ev => {
    const category = ev.category || ev.type || "";
    return {
      id: String(ev.event_id),
      title: ev.title,
      start: ev.start,
      end: ev.end || null,
      classNames: [catClass(category)],
      extendedProps: { ...ev, category }
    };
  });

  if (calendarInstance){
    calendarInstance.removeAllEvents();
    fcEvents.forEach(evt => calendarInstance.addEvent(evt));
    calendarInstance.render();
    return;
  }

  calendarInstance = new FullCalendar.Calendar(el, {
    initialView: "dayGridMonth",
    height: "auto",
    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "dayGridMonth,timeGridWeek,timeGridDay,listWeek"
    },
    events: fcEvents,
    eventClassNames: (arg) => [catClass(arg?.event?.extendedProps?.category)],
    eventDidMount: (arg) => {
      try { arg.el.classList.add(catClass(arg.event.extendedProps?.category)); } catch(_) {}
    },
    eventClick: async (info) => {
      const ev = info.event.extendedProps || {};
      
      // 1. Open immediately with a loading state
      openModal({ ev, loading: true });

      try {
        // 2. Fetch roster and shifts concurrently in the background
        const [roster] = await Promise.all([
          GET({ action:"eventroster", event_id: info.event.id }),
          loadShiftsForEvent(info.event.id)
        ]);
        
        // 3. Re-render modal with the actual data (only if they haven't closed or clicked away)
        if (_modalEventId === String(info.event.id)) {
          openModal({
            ev,
            signupsAccepted: extractSignupsAccepted(roster),
            signupsWait: extractSignupsWait(roster),
            loading: false
          });
        }
      } catch (err) {
        console.error("Error loading event click data:", err);
        if (_modalEventId === String(info.event.id)) {
           document.getElementById("mCap").textContent = "Error loading roster.";
           document.getElementById("mSignups").innerHTML = "";
        }
      }
    }
  });

  calendarInstance.render();
}

function openModal(data){
  const ev = data.ev || {};
  _modalEventId = String(ev.event_id || ev.id || "");

  const isLoading = data.loading === true;
  const sAcc = data.signupsAccepted || [];
  const sWait = data.signupsWait || [];

  document.getElementById("mTitle").textContent = ev.title || ev.event_id || "Event";
  document.getElementById("mWhen").textContent  = `${fmtDate(ev.start)}${ev.end ? (" ‚Üí " + fmtDate(ev.end)) : ""}`;
  document.getElementById("mWhere").textContent = ev.location ? `Location: ${ev.location}` : "";
  const desc = ev.description || ev.details || ev.notes || "";
  document.getElementById("mDesc").textContent = desc ? `Description: ${desc}` : "";

  const capEl = document.getElementById("mCap");
  const limit = Number(ev.signup_capacity || 0);

  if (isLoading) {
    // Show loading state
    capEl.textContent = "Loading sign-ups...";
    document.getElementById("mSignups").innerHTML = '<li class="muted small">Loading roster...</li>';
    document.getElementById("waitHdr").style.display = "none";
    document.getElementById("mWait").innerHTML = "";
    document.getElementById("mShiftWrap").style.display = "none"; 
  } else {
    // Show loaded state
    capEl.textContent = limit > 0 ? `Sign-ups: ${sAcc.length} / ${limit}` : `Sign-ups: ${sAcc.length} (no cap)`;

    setModalShiftUI(_modalEventId); // Process shifts

    const sUL = document.getElementById("mSignups");
    sUL.innerHTML = "";
    if (sAcc.length === 0) {
      sUL.innerHTML = '<li class="muted small">No sign-ups yet.</li>';
    } else {
      sAcc.forEach(s => {
        const li = document.createElement("li");
        const sid = String(s.shift_id ?? s.shiftId ?? s.shift ?? "").trim();
        let sLab = s.shift_title || s.shiftTitle || s.shift_name || "";
        if (!sLab && sid) sLab = shiftLabelById.get(sid) || sid;
        const sTxt = sLab ? ` (Shift: ${sLab})` : "";
        li.textContent = `${s.student_id}${sTxt}`;
        sUL.appendChild(li);
      });
    }

    const wHdr = document.getElementById("waitHdr");
    const wUL = document.getElementById("mWait");
    wUL.innerHTML = "";
    if (sWait.length){
      wHdr.style.display = "block";
      sWait.forEach(s => {
        const li = document.createElement("li");
        const sid = String(s.shift_id ?? s.shiftId ?? s.shift ?? "").trim();
        let sLab = s.shift_title || s.shiftTitle || s.shift_name || "";
        if (!sLab && sid) sLab = shiftLabelById.get(sid) || sid;
        const sTxt = sLab ? ` (Shift: ${sLab})` : "";
        li.textContent = `${s.student_id}${sTxt}`;
        wUL.appendChild(li);
      });
    } else {
      wHdr.style.display = "none";
    }
  }

  document.getElementById("eventModal").style.display = "flex";
}

function closeModal(){ document.getElementById("eventModal").style.display = "none"; }


(async function(){
  document.getElementById("hoursLabel").textContent = "My Semester Total Hours";
  document.getElementById("hoursSub").textContent = CURRENT_SEMESTER;
  const sess = getSession();
  currentStudentId = (sess.username || "").trim();
  if (!currentStudentId){
    document.getElementById("ambGreet").textContent = "Session expired";
    document.getElementById("ambName").textContent = "Please go back and log in again.";
    return;
  }
  document.getElementById("ambGreet").textContent = greetingForNow();
  document.getElementById("ambName").textContent = await resolveStudentName(currentStudentId);

  const sum = await GET({ action:"studentsummary", student_id: currentStudentId });
  const ul = document.getElementById("reqList");
  ul.innerHTML = "";
  const rawReqs = (sum && sum.requirements) ? sum.requirements : [];
  const have = new Map((rawReqs || []).map(r => [String(r.requirement_key), !!r.is_checked]));
  Object.keys(REQUIREMENT_LABELS).forEach(k => {
    const li = document.createElement("li");
    const box = document.createElement("span");
    const checked = have.get(k) === true;
    box.className = "box" + (checked ? " done" : "");
    box.textContent = checked ? "‚úì" : "";
    const label = document.createElement("span");
    label.textContent = REQUIREMENT_LABELS[k];
    li.append(box, label);
    ul.appendChild(li);
  });

  const evResp = await GET({ action:"events" });
  eventsCache = Array.isArray(evResp) ? evResp : (evResp && Array.isArray(evResp.events) ? evResp.events : (evResp && Array.isArray(evResp.rows) ? evResp.rows : []));
  const activeEvents = eventsCache.filter(isActiveEvent);

  initCalendarSafe(activeEvents);

  const reqSel = document.getElementById("reqEvent");
  const btnReq = document.getElementById("btnReq");
  const reqList = [...activeEvents].sort((a,b)=>{
    const ta = Date.parse(a.start); const tb = Date.parse(b.start);
    if (isNaN(ta) && isNaN(tb)) return 0;
    if (isNaN(ta)) return 1;
    if (isNaN(tb)) return -1;
    return tb - ta;
  });
  reqSel.innerHTML = "";
  if (!reqList.length){
    const o = document.createElement("option"); o.value = ""; o.textContent = "No active events available"; reqSel.appendChild(o);
    reqSel.disabled = true; btnReq.disabled = true;
  } else {
    reqSel.disabled = false; btnReq.disabled = false;
    reqList.forEach(ev => {
      const o = document.createElement("option"); o.value = ev.event_id; o.textContent = `${ev.title} ‚Äî ${fmtDate(ev.start)}`;
      reqSel.appendChild(o);
    });
  }

  const suSel  = document.getElementById("signupEvent");
  const btnSu  = document.getElementById("btnSignup");
  const now = Date.now();
  const upcoming = activeEvents.filter(ev => {
    const t = Date.parse(ev.start);
    return !isNaN(t) && t >= now - 86400000;
  }).sort((a,b)=>Date.parse(a.start)-Date.parse(b.start));
  suSel.innerHTML = "";
  if (!upcoming.length){
    const o = document.createElement("option"); o.value = ""; o.textContent = "No upcoming events"; suSel.appendChild(o);
    suSel.disabled = true; btnSu.disabled = true;
  } else {
    suSel.disabled = false; btnSu.disabled = false;
    upcoming.forEach(ev => {
      const o = document.createElement("option"); o.value = ev.event_id;
      const capTxt = ev.signup_capacity ? ` (${ev.signup_capacity} cap)` : "";
      o.textContent = `${ev.title} ‚Äî ${fmtDate(ev.start)}${capTxt}`;
      suSel.appendChild(o);
    });
  }

  /* Link selects to auto-fetch shifts */
  reqSel.addEventListener("change", async (e)=> setShiftUI("req", e.target.value));
  suSel.addEventListener("change", async (e)=> setShiftUI("su", e.target.value));

  if (reqSel.value) await setShiftUI("req", reqSel.value);
  if (suSel.value) await setShiftUI("su", suSel.value);


  /* Submissions */
  document.getElementById("formRequest").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msgEl = document.getElementById("msgReq");
    msgEl.textContent = "";
    if (!reqSel.value){ toast(msgEl, false, "Please choose an event."); return; }

    const shiftId = getSelectedShift("req");
    if (mustPickShiftForEvent(reqSel.value) && !shiftId){
      toast(msgEl, false, "Please select a shift.");
      return;
    }

    const btn = document.getElementById("btnReq");
    btn.disabled = true;
    const hoursToSend = requestedHoursOrEventDefault(document.getElementById("reqHours").value, reqSel.value);
    
    const out = await POST("request", {
      student_id: currentStudentId, 
      event_id: reqSel.value, 
      shift_id: shiftId,
      requested_hours: hoursToSend,
      comment: (document.getElementById("reqComment").value || "").trim(), 
      notify: true, source: "portal_student", current_semester: CURRENT_SEMESTER
    });
    
    toast(msgEl, !!out.ok, out.ok ? "Request submitted!" : (out.error || "Error"));
    btn.disabled = false;
    if (out.ok){
      openConfetti("Attendance request submitted üéâ", `Your attendance request was submitted.<br><br><b>Event:</b> ${eventLabelFromSelect(reqSel)}<br><b>Hours:</b> ${hoursToSend}`);
      document.getElementById("reqHours").value = "";
      document.getElementById("reqComment").value = "";
      await loadHistory();
    }
  });

  document.getElementById("formSignup").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msgEl = document.getElementById("msgSignup");
    msgEl.textContent = "";
    if (!suSel.value){ toast(msgEl, false, "Please choose an event."); return; }

    const shiftId = getSelectedShift("su");
    if (mustPickShiftForEvent(suSel.value) && !shiftId){
      toast(msgEl, false, "Please select a shift.");
      return;
    }

    const btn = document.getElementById("btnSignup");
    btn.disabled = true;
    const hoursToSend = requestedHoursOrEventDefault(document.getElementById("suHours").value, suSel.value);
    
    const out = await POST("signup", {
      student_id: currentStudentId, 
      event_id: suSel.value, 
      shift_id: shiftId,
      created_by: "student", 
      requested_hours: hoursToSend,
      comment: (document.getElementById("suComment").value || "").trim(), 
      notify: true, source: "portal_student", current_semester: CURRENT_SEMESTER
    });
    
    toast(msgEl, !!out.ok, out.ok ? `Sign-up ${out.status === "accepted" ? "confirmed ‚úÖ" : "waitlisted ‚è≥"}` : (out.error || "Error"));
    btn.disabled = false;
    if (out.ok){
      const statusLine = (out.status === "accepted") ? "You were accepted!" : "You were added to the waitlist.";
      openConfetti("Sign-up submitted üéâ", `Your sign-up was submitted.<br><br><b>Event:</b> ${eventLabelFromSelect(suSel)}<br><b>Status:</b> ${statusLine}<br><b>Hours:</b> ${hoursToSend}`);
      document.getElementById("suHours").value = "";
      document.getElementById("suComment").value = "";
      await loadHistory();
    }
  });

  await loadHistory();
})();

async function fetchRequestsWithFallback(studentId){
  const actionsToTry = ["requests", "requesthistory", "history"];
  for (const action of actionsToTry){
    try{
      const resp = await GET({ action, student_id: studentId });
      const rows = normalizeRequestsList(resp);
      const cleaned = (rows || []).filter(r => r && r.hours_awarded == null).filter(r => belongsToCurrentStudent(r, studentId));
      if (cleaned && cleaned.length){ return cleaned; }
    }catch(_){}
  }
  return [];
}

async function loadHistory(){
  try{
    const attResp = await GET({ action:"attendance", student_id: currentStudentId });
    const attRows = normalizeAttendanceList(attResp).filter(r => belongsToCurrentStudent(r, currentStudentId)).map(r => ({ ...r, _type:"attendance" }));
    _attendanceCache = attRows;
    const reqRowsRaw = await fetchRequestsWithFallback(currentStudentId);
    const reqRows = (reqRowsRaw || []).filter(r => belongsToCurrentStudent(r, currentStudentId)).map(r => ({ ...r, _type:"request" }));
    _requestsCache = reqRows;
    _fullHistoryCache = [..._attendanceCache, ..._requestsCache];
    const semesters = Array.from(new Set(_fullHistoryCache.map(r => rowSemester(r)))).sort((a,b)=>a.localeCompare(b));
    const sel = document.getElementById("histSem");
    sel.innerHTML = "";
    if (!semesters.length){
      sel.innerHTML = `<option value="">No history yet</option>`;
      document.getElementById("histRows").innerHTML = `<tr><td colspan="6" class="muted small">No history yet.</td></tr>`;
      document.getElementById("histSemTotal").textContent = "0"; document.getElementById("histAllTotal").textContent = "0"; document.getElementById("hoursTotal").textContent = "0";
      toastHist(true, "");
      return;
    }
    semesters.forEach(s => { const o = document.createElement("option"); o.value = s; o.textContent = s; sel.appendChild(o); });
    sel.value = semesters.includes(CURRENT_SEMESTER) ? CURRENT_SEMESTER : semesters[semesters.length - 1];
    const allTotal = _attendanceCache.reduce((acc,r)=>acc + hoursNum(r.hours_awarded), 0);
    document.getElementById("histAllTotal").textContent = (Math.round(allTotal*100)/100).toString();
    sel.onchange = () => renderHistory(sel.value);
    renderHistory(sel.value);
    syncTopHoursToCurrentSemester();
    if (!_requestsCache.length){ toastHist(true, "Note: No requests were returned for your account."); } else { toastHist(true, ""); }
  } catch (e){
    toastHist(false, "History failed to load.");
    document.getElementById("histRows").innerHTML = `<tr><td colspan="6" class="muted small">History unavailable.</td></tr>`;
  }
}

function syncTopHoursToCurrentSemester(){
  const sem = String(CURRENT_SEMESTER || "").trim();
  const rows = (_attendanceCache || []).filter(r => rowSemester(r) === sem);
  const total = rows.reduce((acc,r)=>acc + hoursNum(r.hours_awarded), 0);
  document.getElementById("hoursTotal").textContent = (Math.round(total*100)/100).toString();
  document.getElementById("hoursSub").textContent = CURRENT_SEMESTER;
}

function renderHistory(sem){
  const semKey = String(sem || "");
  const rows = (_fullHistoryCache || []).filter(r => belongsToCurrentStudent(r, currentStudentId)).filter(r => rowSemester(r) === semKey);
  const tbody = document.getElementById("histRows");
  tbody.innerHTML = "";
  const semAtt = (_attendanceCache || []).filter(r => rowSemester(r) === semKey);
  const semTotal = semAtt.reduce((acc,r)=>acc + hoursNum(r.hours_awarded), 0);
  document.getElementById("histSemTotal").textContent = (Math.round(semTotal*100)/100).toString();
  if (!rows.length){ tbody.innerHTML = `<tr><td colspan="6" class="muted small">No history in this semester.</td></tr>`; return; }
  rows.sort((a,b)=>rowDateKey(b)-rowDateKey(a));
  
  rows.forEach(r => {
    const sid = String(r.shift_id ?? r.shiftId ?? r.shift ?? "").trim();
    let sLab = r.shift_title || r.shiftTitle || r.shift_name || "";
    if (!sLab && sid) sLab = shiftLabelById.get(sid) || sid;
    const sTxt = sLab ? ` (Shift: ${sLab})` : "";
    const title = (rowEventTitle(r) || "‚Äî") + sTxt;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="tag">${rowSemester(r)}</span></td>
      <td>${title}</td>
      <td>${rowEventDateForDisplay(r)}</td>
      <td>${String(rowHoursForDisplay(r))}</td>
      <td><span class="emoji-bg">${statusIconForRow(r)}</span></td>
      <td>${rowComment(r)}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ===== MODAL QUICK ACTIONS ===== */
function _setSelectIfExists(selectId, value){
  const sel = document.getElementById(selectId);
  if (!sel) return { ok:false, reason:"missing-select" };
  const v = String(value || "").trim();
  if (!v) return { ok:false, reason:"missing-value" };
  const opt = Array.from(sel.options || []).find(o => String(o.value) === v);
  if (!opt) return { ok:false, reason:"not-in-dropdown" };
  sel.value = v;
  return { ok:true };
}

function _jumpToForm(formId, focusId){
  const form = document.getElementById(formId);
  if (!form) return;
  closeModal();
  form.scrollIntoView({ behavior:"smooth", block:"start" });
  if (focusId){ setTimeout(() => { const el = document.getElementById(focusId); if (el && typeof el.focus === "function") el.focus(); }, 250); }
}

async function modalSignup(){
  const res = _setSelectIfExists("signupEvent", _modalEventId);
  if (!res.ok){ openConfetti("Can‚Äôt sign up from this event", "This event is not available in your Sign-up dropdown."); return; }
  await setShiftUI("su", _modalEventId);
  const s = modalSelectedShift();
  if (s) _setSelectIfExists("suShift", s);
  _jumpToForm("formSignup", "suComment");
}

async function modalRequestAttendance(){
  const res = _setSelectIfExists("reqEvent", _modalEventId);
  if (!res.ok){ openConfetti("Can‚Äôt request attendance", "This event is not available in your Attendance Request dropdown."); return; }
  await setShiftUI("req", _modalEventId);
  const s = modalSelectedShift();
  if (s) _setSelectIfExists("reqShift", s);
  _jumpToForm("formRequest", "reqComment");
}
</script>
</body>
</html>

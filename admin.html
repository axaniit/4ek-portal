<meta name="robots" content="noindex, nofollow">

<div id="admin-app" style="max-width:1100px;margin:0 auto;">
  <header class="amb-top">
    <div>
      <div class="muted" id="adminGreet">Welcome</div>
      <div class="h-name" id="adminName">â€”</div>
    </div>
    <div class="hours">
      <div class="muted">My Semester Total Hours</div>
      <div class="h-big" id="meHoursTotal">0</div>
      <div class="muted small" id="meHoursSub" style="margin-top:2px;">Spring2026</div>
    </div>
  </header>

  <section class="top-grid">
    <div class="card">
      <div class="card-h">Quick Actions (My Requests)</div>
      <div class="card-b">
        <form id="formRequest" class="form" autocomplete="off">
          <h4>Attendance Request</h4>
          <label>Choose event
            <select id="reqEvent"></select>
          </label>

          <label id="reqShiftWrap" style="display:none;">Shift
            <select id="reqShift"></select>
            <div class="muted small" id="reqShiftHint" style="margin-top:6px;"></div>
          </label>

          <div class="grid2" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <label>Requested hours (optional)
              <input id="reqHours" type="number" step="0.25" min="0" placeholder="e.g., 3">
            </label>
            <div class="muted small" style="display:flex;align-items:center;">
              If you didnâ€™t attend the full time, enter how many hours you did attend.
            </div>
          </div>
          <label>Comment (notes, times youâ€™re available, etc.)
            <textarea id="reqComment" rows="2" placeholder="I can work 2â€“4pm because â€¦"
              style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;"></textarea>
          </label>
          <button id="btnReq" type="submit">Submit request</button>
          <div class="msg" id="msgReq"></div>
        </form>

        <hr style="margin:16px 0;border:none;border-top:1px solid #eee;">

        <form id="formSignup" class="form" autocomplete="off">
          <h4>Event Sign-Up</h4>
          <label>Choose event
            <select id="signupEvent"></select>
          </label>

          <label id="suShiftWrap" style="display:none;">Shift
            <select id="suShift"></select>
            <div class="muted small" id="suShiftHint" style="margin-top:6px;"></div>
          </label>

          <div class="grid2" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <label>Requested hours (optional)
              <input id="suHours" type="number" step="0.25" min="0" placeholder="e.g., 3">
            </label>
            <div class="muted small" style="display:flex;align-items:center;">
              If you plan to attend part of the time, enter the hours here.
            </div>
          </div>
          <label>Comment (notes, times youâ€™re available, etc.)
            <textarea id="suComment" rows="2" placeholder="Iâ€™m available after class at 3:30â€¦"
              style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;"></textarea>
          </label>
          <button id="btnSignup" type="submit">Sign up</button>
          <div class="msg" id="msgSignup"></div>
        </form>

        <hr style="margin:16px 0;border:none;border-top:1px solid #eee;">

        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <h4 style="margin:.25rem 0;">My History</h4>
            <button id="btnMeRefresh" type="button" class="secondary"
              style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;">
              Refresh
            </button>
          </div>

          <div class="muted small" style="margin-bottom:10px;">
            This shows your <b>requests</b> and your <b>approved attendance</b>. Totals only include approved attendance hours.
          </div>

          <div class="hist-top">
            <div class="hist-card">
              <div class="muted small">Semester</div>
              <select id="histSem" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;"></select>
            </div>
            <div class="hist-card">
              <div class="muted small">Semester Total (approved)</div>
              <div class="hist-big" id="histSemTotal">0</div>
            </div>
            <div class="hist-card">
              <div class="muted small">All-Time Total (approved)</div>
              <div class="hist-big" id="histAllTotal">0</div>
            </div>
          </div>

          <div class="hist-scroll" style="margin-top:10px;">
            <table class="hist-table">
              <thead>
                <tr>
                  <th style="min-width:140px;">Semester</th>
                  <th style="min-width:220px;">Event</th>
                  <th style="min-width:160px;">Date</th>
                  <th style="min-width:90px;">Hours</th>
                  <th style="min-width:90px;">Status</th>
                  <th style="min-width:260px;">Comments</th>
                </tr>
              </thead>
              <tbody id="histRows">
                <tr><td colspan="6" class="muted small">Loadingâ€¦</td></tr>
              </tbody>
            </table>
          </div>

          <div class="msg" id="msgHist" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>

    <div class="card" id="pcCard">
      <div class="card-h">Pending Center (All Events)</div>
      <div class="card-b" id="pcCardBody">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
          <button id="pcRefresh" class="btnPrimary" type="button">Refresh</button>
          <input id="pcSearch" placeholder="Search student / event / commentâ€¦" style="flex:1;min-width:220px;padding:8px;border:1px solid #ccc;border-radius:8px">
          <select id="pcEvent" style="min-width:220px;padding:8px;border:1px solid #ccc;border-radius:8px">
            <option value="">All events</option>
          </select>
          <select id="pcCat" style="min-width:160px;padding:8px;border:1px solid #ccc;border-radius:8px">
            <option value="">All categories</option>
            <option>Socials</option>
            <option>Events</option>
            <option>Meetings</option>
            <option>Deadlines</option>
          </select>
        </div>

        <div id="pcStatus" class="muted small" style="margin-bottom:8px;">Loadingâ€¦</div>

        <div id="pcTableWrap">
          <table class="ptable">
            <thead>
              <tr>
                <th style="width:28px"><input type="checkbox" id="pcAll"></th>
                <th>Event</th>
                <th>Student</th>
                <th>Requested hours</th>
                <th>Comment</th>
                <th style="min-width:170px;">Actions</th>
              </tr>
            </thead>
            <tbody id="pcBody"></tbody>
          </table>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap;">
          <button id="pcApproveSel" type="button" class="secondary">Approve selected</button>
          <button id="pcDenySel" type="button" class="secondary">Deny selected</button>
        </div>
      </div>
    </div>
  </section>

  <div class="card">
    <div class="card-h">Calendar (click an event)</div>
    <div class="card-b"><div id="calendar"></div></div>
  </div>

  <div class="card" id="evCard">
    <div class="card-h">Create / Update Event</div>
    <div class="card-b">
      <div class="ev-scroll">
        <form id="eventForm" class="form" autocomplete="off" onsubmit="return false;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;min-width:980px;">
            <label>Event ID <input id="ev_id" placeholder="EVT001" required></label>
            <label>Title <input id="ev_title" required></label>

            <label>Category
              <select id="ev_cat">
                <option>Socials</option>
                <option>Events</option>
                <option>Meetings</option>
                <option>Deadlines</option>
              </select>
            </label>

            <label>Signup Capacity (0=unlimited) <input id="ev_cap" type="number" value="0"></label>

            <label>Start <input id="ev_start" type="datetime-local" required></label>
            <label>End <input id="ev_end" type="datetime-local"></label>

            <label>Location <input id="ev_loc"></label>
            <label>Hours Value <input id="ev_hours" type="number" step="0.25" value="0"></label>
          </div>

          <label style="margin-top:10px;">Notes
            <input id="ev_notes">
          </label>

          <div class="shift-admin">
            <div class="shift-admin-top">
              <label style="display:flex;align-items:center;gap:10px;margin:0;">
                <input id="ev_hasShifts" type="checkbox" style="width:auto;">
                <span style="font-weight:700;">This event uses shifts</span>
              </label>

              <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
                <button id="ev_addShift" type="button" class="secondary" style="display:none;">Add shift</button>
                <button id="ev_removeAllShifts" type="button" class="secondary" style="display:none;">Remove all shifts</button>
              </div>
            </div>

            <div id="ev_shiftsBox" style="display:none;margin-top:10px;">
              <label style="display:flex;align-items:center;gap:10px;margin:0 0 10px;">
                <input id="ev_shiftsRequired" type="checkbox" style="width:auto;">
                <span>Shift selection required (for sign-ups / requests)</span>
              </label>

              <div class="muted small" style="margin-bottom:10px;">
                Shifts are <b>not shown on the calendar</b>. They only appear after you click an event (dropdown in the event modal).
                You can leave this section empty if there arenâ€™t shifts.
              </div>

              <div class="shift-scroll">
                <table class="shift-table">
                  <thead>
                    <tr>
                      <th style="min-width:160px;">Shift title</th>
                      <th style="min-width:190px;">Start</th>
                      <th style="min-width:190px;">End</th>
                      <th style="min-width:140px;">Capacity</th>
                      <th style="min-width:110px;">Active</th>
                      <th style="min-width:120px;">Remove</th>
                    </tr>
                  </thead>
                  <tbody id="ev_shiftsBody"></tbody>
                </table>
              </div>

              <div class="muted small" id="ev_shiftStatus" style="margin-top:8px;"></div>
            </div>
          </div>

          <button type="button" id="saveEventBtn">Save Event</button>
          <span class="msg" id="evMsg"></span>
        </form>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-h">Requirements (Admin)</div>
    <div class="card-b">
      <div class="muted small" style="margin-bottom:10px;">
        Load a student, then check/uncheck requirements. Changes save immediately.
      </div>

      <label style="display:block;font-weight:600;">Find Student</label>
      <input id="rq_search" placeholder="Type email or nameâ€¦" list="rq_students"
             style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;">
      <datalist id="rq_students"></datalist>

      <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap;">
        <button id="rq_load" type="button" class="secondary"
                style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;">
          Load
        </button>
        <button id="rq_check_all" type="button" class="secondary"
                style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;">
          Check all
        </button>
        <button id="rq_uncheck_all" type="button" class="secondary"
                style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;">
          Uncheck all
        </button>
      </div>

      <div id="rq_sel" style="margin-top:10px;font-size:14px;"></div>
      <div id="rq_status" class="muted small" style="margin-top:6px;">Ready</div>

      <div id="rq_list" style="margin-top:12px;border:1px solid #eee;border-radius:10px;min-height:120px;"></div>
    </div>
  </div>
</div>

<div id="confettiOverlay" style="display:none;position:fixed;inset:0;pointer-events:none;z-index:10001;">
  <canvas id="confettiCanvas" style="position:absolute;inset:0;width:100%;height:100%;"></canvas>
</div>

<div id="confettiModal" class="modal" style="display:none;">
  <div class="modal-dialog" style="width:min(560px,100%);position:relative;">
    <div class="modal-h">
      <div id="cTitle">Success ðŸŽ‰</div>
      <button class="x" onclick="closeConfetti()">Ã—</button>
    </div>
    <div class="modal-b" style="position:relative;">
      <div id="cBody" style="position:relative;">Done.</div>
    </div>
    <div class="modal-f">
      <button class="secondary" onclick="closeConfetti()">Close</button>
    </div>
  </div>
</div>

<div id="portalPopup" class="pp-wrap" style="display:none;">
  <div class="pp-card" role="dialog" aria-modal="true" aria-labelledby="ppTitle">
    <div class="pp-icon" id="ppIcon" aria-hidden="true">âœ“</div>
    <div class="pp-title" id="ppTitle">Done</div>
    <div class="pp-msg" id="ppMsg">â€”</div>
    <div class="pp-actions">
      <button id="ppOk" class="pp-btn" type="button">OK</button>
    </div>
  </div>
</div>

<div id="eventModal" class="modal" style="display:none;">
  <div class="modal-dialog">
    <div class="modal-h">
      <div id="mTitle">Event</div>
      <button class="x" id="mClose" type="button">Ã—</button>
    </div>
    <div class="modal-b">
      <div id="mWhen"></div>
      <div id="mWhere" class="muted"></div>
      <div id="mDesc" class="muted"></div>
      <div id="mCap" class="cap"></div>

      <div id="mShiftWrap" class="self-actions" style="display:none;margin-top:10px;">
        <div class="muted small" style="margin-bottom:6px;">This event uses shifts:</div>
        <label style="margin:0;">Shift
          <select id="mShift" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;"></select>
        </label>
        <div class="muted small" id="mShiftHint" style="margin-top:6px;"></div>
      </div>

      <div class="self-actions">
        <div class="muted small" style="margin-bottom:6px;">Quick action for you (admin) on this event:</div>
        <div class="self-row">
          <label style="margin:0;">Hours (optional)
            <input id="mMyHours" type="number" step="0.25" min="0" placeholder="e.g., 2.5">
          </label>
          <label style="margin:0;">Comment (optional)
            <input id="mMyComment" type="text" placeholder="Notesâ€¦">
          </label>
        </div>
        <div class="self-btns">
          <button id="mBtnSignupMe" class="btnPrimary" type="button">Sign up (me)</button>
          <button id="mBtnRequestMe" class="btnPrimary" type="button">Request Attendance (me)</button>
          <span class="muted small" id="mMyStatus" style="margin-left:8px;"></span>
        </div>
      </div>

      <div class="rosters">
        <div>
          <h5>Approved Attendance</h5>
          <div class="muted small">These entries already count toward hours.</div>
          <ul id="mApproved" class="roster"></ul>
        </div>
        <div>
          <h5>Sign-ups</h5>
          <div class="muted small">Sign-ups donâ€™t affect hours.</div>
          <ul id="mSignups" class="roster"></ul>

          <h6 class="muted" id="waitHdr" style="display:none;margin-top:8px;">Waitlist</h6>
          <ul id="mWait" class="roster"></ul>
        </div>
      </div>
    </div>
    <div class="modal-f">
      <button class="secondary" id="loadToFormBtn" type="button">Load into event editor</button>
      <button class="secondary" id="closeBtn" type="button">Close</button>
    </div>
  </div>
</div>

<style>
  @import url("https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css");

  #calendar{ min-height: 640px; }
  #calendar, #calendar * { font-family: inherit; }

  .amb-top{display:flex;justify-content:space-between;align-items:flex-end;margin:8px 0 16px}
  .muted{color:#666}.small{font-size:12px}.h-name{font-weight:600;font-size:18px}
  .h-big{font-size:40px;font-weight:700}.hours{text-align:right}

  .top-grid{display:grid;gap:16px;margin:0 0 16px;align-items:stretch}
  @media (min-width: 980px){ .top-grid{ grid-template-columns: 1fr 1fr; } }
  .top-grid > .card{ height:100%; display:flex; flex-direction:column; }
  .top-grid > .card .card-b{ flex:1; min-height:0; }

  .card{border:1px solid #e5e5e5;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.04);overflow:hidden;background:#fff;margin:12px 0}
  .card-h{padding:12px 16px;border-bottom:1px solid #eee;font-weight:600}
  .card-b{padding:16px}

  .form h4{margin:.25rem 0 .5rem}
  .form label{display:block;margin:8px 0}
  .form select, .form input, .form textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}
  .form button{margin-top:6px;padding:10px 14px;border:0;background:#111;color:#fff;border-radius:8px;cursor:pointer}
  .form button:hover{opacity:.9}
  .form button:disabled{opacity:.6;cursor:not-allowed}

  .btnPrimary{padding:10px 14px;border:0;background:#111;color:#fff;border-radius:8px;cursor:pointer}
  .secondary{padding:8px 10px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer}
  .secondary:hover{background:#fafafa}

  .msg{margin-top:8px;font-size:13px}.ok{color:#1a7f37}.err{color:#b00020}

  .rq-row{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:10px 12px;border-bottom:1px solid #f4f4f4}
  .rq-row:last-child{border-bottom:none}
  .rq-lbl{display:flex;align-items:flex-start;gap:10px}
  .rq-meta{color:#666;font-size:12px;margin-top:2px}
  .rq-pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #e6e6e6;font-size:12px}

  .ptable{width:100%;border-collapse:collapse}
  .ptable th,.ptable td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #e6e6e6;font-size:12px}
  .actBtn{padding:6px 10px;border:0;border-radius:8px;cursor:pointer}
  .approve{background:#0f7b3d;color:#fff}
  .deny{background:#b00020;color:#fff}

  /* Pending Center: make table area scroll vertically + horizontally */
  #pcCardBody{display:flex;flex-direction:column;min-height:0}
  #pcTableWrap{
    flex:1;
    min-height:0;
    overflow:auto;
    border:1px solid #eee;
    border-radius:10px;
  }

  /* ===== CREATE/EDIT EVENT: FORCE H-SCROLL ===== */
  .ev-scroll{
    overflow-x:auto;
    overflow-y:hidden;
    padding-bottom:6px;
  }
  .ev-scroll::-webkit-scrollbar{ height:10px }
  .ev-scroll::-webkit-scrollbar-thumb{ background:rgba(0,0,0,.22); border-radius:999px }
  .ev-scroll::-webkit-scrollbar-track{ background:rgba(0,0,0,.05); border-radius:999px }

  /* ===== SHIFT EDITOR ===== */
  .shift-admin{
    margin-top:12px;
    border:1px solid #eee;
    border-radius:12px;
    background:#fafafa;
    padding:12px;
  }
  .shift-admin-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .shift-scroll{
    overflow:auto;
    border:1px solid #eee;
    border-radius:12px;
    background:#fff;
  }
  .shift-table{
    width:100%;
    border-collapse:collapse;
    min-width:880px;
  }
  .shift-table th,.shift-table td{
    padding:10px 8px;
    border-bottom:1px solid #eee;
    text-align:left;
    vertical-align:top;
    font-size:13px;
  }
  .shift-table th{
    font-size:12px;
    color:#666;
    text-transform:uppercase;
    letter-spacing:.02em;
    background:#fafafa;
    position:sticky;
    top:0;
    z-index:1;
  }
  .shift-table input[type="datetime-local"],
  .shift-table input[type="number"],
  .shift-table input[type="text"]{
    width:100%;
    padding:8px;
    border:1px solid #ccc;
    border-radius:8px;
    background:#fff;
  }
  .shift-table input[type="checkbox"]{ width:auto; }

  /* ===== HISTORY STYLES ===== */
  .hist-top{display:grid;gap:10px}
  @media (min-width: 900px){
    .hist-top{ grid-template-columns: 1fr 1fr 1fr; }
  }
  .hist-card{
    border:1px solid #eee;
    border-radius:12px;
    padding:12px;
    background:#fafafa
  }
  .hist-big{
    font-size:28px;
    font-weight:700;
    margin-top:4px
  }
  .hist-table{
    width:100%;
    border-collapse:collapse
  }
  .hist-table th,
  .hist-table td{
    border-bottom:1px solid #eee;
    padding:10px 8px;
    text-align:left;
    vertical-align:top
  }
  .hist-table th{
    font-size:12px;
    color:#666;
    text-transform:uppercase;
    letter-spacing:.02em
  }
  .tag{
    display:inline-block;
    padding:2px 8px;
    border:1px solid #ddd;
    border-radius:999px;
    font-size:12px;
    color:#444;
    background:#fff
  }
  .hist-scroll{
    max-height:320px;
    overflow-y:scroll;
    overflow-x:auto;
    border:1px solid #eee;
    border-radius:12px
  }
  .hist-scroll::-webkit-scrollbar{ width:10px; height:10px }
  .hist-scroll::-webkit-scrollbar-thumb{
    background:rgba(0,0,0,.22);
    border-radius:999px
  }
  .hist-scroll::-webkit-scrollbar-track{
    background:rgba(0,0,0,.05);
    border-radius:999px
  }

  /* Event modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999}
  #eventModal .modal-dialog{width:min(920px,100%);background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.2)}
  #eventModal .modal-h{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #eee}
  #eventModal .modal-b{padding:16px}
  #eventModal .modal-f{padding:12px 16px;border-top:1px solid #eee;text-align:right;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  #eventModal .modal .x{background:transparent;border:0;font-size:22px;cursor:pointer}
  .rosters{display:grid;gap:16px;margin-top:12px}
  @media (min-width: 900px){ .rosters{ grid-template-columns: 1fr 1fr; } }
  .roster{margin:.25rem 0 0;padding-left:18px}
  .cap{margin:8px 0 0;font-weight:600}

  .self-actions{margin:12px 0 0;padding:12px;border:1px solid #eee;border-radius:12px;background:#fafafa}
  .self-row{display:grid;grid-template-columns:220px 1fr;gap:10px;align-items:end}
  .self-row input{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}
  .self-btns{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}

  .fc, .fc * { pointer-events:auto; }
  .fc-event, .fc-event * { pointer-events:auto !important; }

  /* Toolbar readability */
  .fc .fc-toolbar{
    background:#fff;
    border:1px solid #eee;
    border-radius:12px;
    padding:10px 12px;
    margin-bottom:12px;
  }
  .fc .fc-toolbar-title{ font-weight:700; color:#111; }
  .fc .fc-button{
    background:#fff !important;
    border:1px solid #ddd !important;
    color:#111 !important;
    box-shadow:none !important;
    text-transform:none !important;
    opacity:1 !important;
  }
  .fc .fc-button .fc-icon{ color:#111 !important; }
  .fc .fc-button:hover{ background:#f7f7f7 !important; }
  .fc .fc-button:disabled{ opacity:.55 !important; }
  .fc .fc-button-primary:not(:disabled).fc-button-active,
  .fc .fc-button-primary:not(:disabled):active{
    background: rgba(201,162,39,.15) !important;
    border-color: rgba(201,162,39,.45) !important;
    color:#111 !important;
  }

  /* Kill FullCalendar default blue */
  .fc .fc-event,
  .fc .fc-event-main,
  .fc .fc-daygrid-event,
  .fc .fc-timegrid-event{
    background: transparent !important;
    border-color: transparent !important;
  }
  .fc .fc-list-event:hover td{ background: rgba(0,0,0,.03) !important; }

  :root { --ucf-gold:#C9A227; --ucf-black:#000; --ucf-purple:#6A0DAD; --ucf-red:#C1121F; }

  .cat-gold  .fc-daygrid-event-dot, .cat-gold  .fc-list-event-dot { border-color:var(--ucf-gold) !important; background:var(--ucf-gold) !important; }
  .cat-black .fc-daygrid-event-dot, .cat-black .fc-list-event-dot { border-color:var(--ucf-black)!important; background:var(--ucf-black)!important; }
  .cat-purple .fc-daygrid-event-dot, .cat-purple .fc-list-event-dot { border-color:var(--ucf-purple)!important; background:var(--ucf-purple)!important; }
  .cat-red   .fc-daygrid-event-dot, .cat-red   .fc-list-event-dot { border-color:var(--ucf-red)  !important; background:var(--ucf-red)  !important; }

  .fc-timegrid-event{ border-radius:10px !important; overflow:hidden; }
  .fc-timegrid-event.cat-gold  { border-left: 4px solid var(--ucf-gold) !important;  border:1px solid rgba(201,162,39,.35) !important; background: rgba(201,162,39,.10) !important; }
  .fc-timegrid-event.cat-black { border-left: 4px solid var(--ucf-black)!important; border:1px solid rgba(0,0,0,.25) !important;     background: rgba(0,0,0,.06) !important; }
  .fc-timegrid-event.cat-purple{ border-left: 4px solid var(--ucf-purple)!important;border:1px solid rgba(106,13,173,.30) !important;   background: rgba(106,13,173,.10) !important; }
  .fc-timegrid-event.cat-red   { border-left: 4px solid var(--ucf-red)  !important;  border:1px solid rgba(193,18,31,.30) !important;    background: rgba(193,18,31,.10) !important; }

  /* Student-style popup */
  .pp-wrap{
    position:fixed; inset:0;
    background:rgba(0,0,0,.45);
    display:flex; align-items:center; justify-content:center;
    padding:16px;
    z-index:100000;
  }
  .pp-card{
    width:min(420px,100%);
    background:#fff;
    border-radius:14px;
    box-shadow:0 20px 60px rgba(0,0,0,.25);
    padding:18px 18px 14px;
    text-align:center;
  }
  .pp-icon{
    width:46px;height:46px;border-radius:999px;
    background:#111;color:#fff;
    display:flex;align-items:center;justify-content:center;
    margin:0 auto 10px;
    font-weight:800;
  }
  .pp-icon.bad{ background:#b00020; }
  .pp-title{ font-weight:700;font-size:18px;margin:4px 0 6px; }
  .pp-msg{
    color:#333;font-size:14px;line-height:1.35;
    margin:0 0 12px;
    white-space:pre-wrap;
  }
  .pp-actions{ display:flex;justify-content:center; }
  .pp-btn{
    padding:10px 18px;border:0;border-radius:10px;
    background:#111;color:#fff;cursor:pointer;
  }
  .pp-btn:hover{ opacity:.92; }

  /* Confetti modal scoped */
  #confettiModal{ z-index:10002; }
  #confettiModal.modal{
    position:fixed;inset:0;background:rgba(0,0,0,.4);
    display:flex;align-items:center;justify-content:center;padding:16px;
  }
  #confettiModal .modal-dialog{
    width:min(820px,100%);
    background:#fff;border-radius:12px;overflow:hidden;
    box-shadow:0 20px 60px rgba(0,0,0,.2)
  }
  #confettiModal .modal-h{
    display:flex;justify-content:space-between;align-items:center;
    padding:12px 16px;border-bottom:1px solid #eee
  }
  #confettiModal .modal-b{ padding:16px;min-height:140px }
  #confettiModal .modal-f{
    padding:12px 16px;border-top:1px solid #eee;text-align:right;
    display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap
  }
  #confettiModal .x{background:transparent;border:0;font-size:22px;cursor:pointer}
  #confettiModal .secondary{padding:10px 14px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
  #confettiModal .secondary:hover{background:#f7f7f7}
/* ===== FIX: Pending Center scroll + hard cap ===== */
#pcCard{
  display:flex;
  flex-direction:column;
}

#pcCardBody{
  display:flex;
  flex-direction:column;
  flex:1;
  min-height:0;
}

#pcTableWrap{
  flex:1;
  min-height:0;
  max-height:1000px;
  overflow-y:auto;
  overflow-x:auto;
}


</style>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script>
/* ===== CONFIG ===== */
const API = "https://script.google.com/macros/s/AKfycbxUUnLnZWfYGe0ZJ5NKtoLXa78qXCK-cEeCv2Ip_3Xm_XUDy-fFp-w0gShBxakcjJdCPg/exec";
const SESSION_KEY = "portal_session_v1";
const CURRENT_SEMESTER = "Spring2026";

/* ===== REQUIREMENTS ===== */
const REQUIREMENT_LABELS = {
  "2 Tailgates": "2 Tailgates",
  "2 Regalia Shifts": "2 Regalia Shifts (spring)",
  "1 Homecoming event": "1 Homecoming event",
  "1 Recruitment event": "1 Recruitment event",
  "Student Philanthropy Celebration": "Student Philanthropy Celebration",
  "Day of Giving": "Day of Giving",
  "2 Socials": "2 Socials (spring)",
  "Fall Retreat or Makeup": "Fall Retreat or Makeup",
  "30 Hours (spring)": "30 Hours (spring)"
};

/* ===== UTIL ===== */
function _norm(v){ return String(v == null ? "" : v).trim().toLowerCase(); }
function esc(s){ return String(s == null ? "" : s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function isTrue(v){
  if (typeof v === "boolean") return v === true;
  const s = String(v ?? "").trim().toLowerCase();
  return s === "true" || s === "yes" || s === "1";
}
function nl2br(s){ return String(s ?? "").replace(/\n/g, "<br>"); }

function getSession(){ try { return JSON.parse(localStorage.getItem(SESSION_KEY) || "{}"); } catch(e){ return {}; } }
function toast(el, ok, msg){ el.className = "msg " + (ok ? "ok" : "err"); el.textContent = msg || ""; }

async function GET(q){
  const r = await fetch(API + "?" + new URLSearchParams(q), { mode:"cors", cache:"no-cache" });
  const t = await r.text();
  try { return JSON.parse(t); } catch { return { ok:false, error:"Non-JSON response", body:t }; }
}
async function POST(action, payload){
  const r = await fetch(API + "?action=" + encodeURIComponent(action), {
    method:"POST",
    mode:"cors",
    cache:"no-cache",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(payload || {})
  });
  const t = await r.text();
  try { return JSON.parse(t); } catch { return { ok:false, error:"Non-JSON response", body:t }; }
}

/* Try multiple GET action names (helps when Apps Script names differ) */
async function GET_tryActions(actions, params){
  let last = null;
  for (const act of actions){
    const out = await GET({ ...(params||{}), action: act });
    last = out;
    if (!out) continue;
    if (out.ok === true) return out;
    if (Array.isArray(out)) return out;
    if (out.rows || out.data || out.shifts || out.pending || out.requests) return out;
  }
  return last || { ok:false, error:"No matching GET action worked" };
}

/* Try multiple POST action names (helps when Apps Script names differ) */
async function POST_tryActions(actions, payload){
  let last = null;
  for (const act of actions){
    const out = await POST(act, payload);
    last = out;
    if (out && out.ok) return out;
  }
  return last || { ok:false, error:"No matching POST action worked" };
}

function fmtDate(dt){
  try{
    const d = new Date(dt);
    return d.toLocaleString([], { weekday:"short", month:"short", day:"numeric", hour:"numeric", minute:"2-digit" });
  }catch(_){ return String(dt); }
}
function fmtShortDate(dt){
  try{
    const d = new Date(dt);
    return d.toLocaleDateString([], { year:"numeric", month:"short", day:"numeric" });
  }catch(_){ return String(dt); }
}
function toLocalInput(dt){
  const d = new Date(dt);
  if (isNaN(d)) return '';
  const p = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
}
function safeHours(val){
  const raw = String(val ?? "").trim();
  if (raw === "") return null;
  const n = Number(raw);
  if (!isFinite(n) || n < 0) return null;
  return n;
}
function greetingForNow(){
  const h = new Date().getHours();
  if (h >= 5 && h < 12) return "Good Morning";
  if (h >= 12 && h < 17) return "Good Afternoon";
  if (h >= 17 && h < 22) return "Good Evening";
  return "Donâ€™t Stay Up Too Late";
}
function hoursNum(v){
  const n = Number(v);
  return isFinite(n) ? n : 0;
}
function normalizeAttendanceList(resp){
  if (Array.isArray(resp)) return resp;
  if (resp && Array.isArray(resp.rows)) return resp.rows;
  if (resp && Array.isArray(resp.attendance)) return resp.attendance;
  return [];
}
function isMobileCal(){
  return window.matchMedia && window.matchMedia("(max-width: 720px)").matches;
}

/* ===== POPUP HELPERS ===== */
const pp = {
  wrap: () => document.getElementById("portalPopup"),
  icon: () => document.getElementById("ppIcon"),
  title:() => document.getElementById("ppTitle"),
  msg:  () => document.getElementById("ppMsg"),
  ok:   () => document.getElementById("ppOk")
};
function showPopup(ok, title, message){
  const w = pp.wrap(), ic = pp.icon(), t = pp.title(), m = pp.msg();
  if (!w || !ic || !t || !m) return;
  ic.textContent = ok ? "âœ“" : "!";
  ic.classList.toggle("bad", !ok);
  t.textContent = title || (ok ? "Done" : "Something went wrong");
  m.textContent = message || "";
  w.style.display = "flex";
}
function hidePopup(){
  const w = pp.wrap();
  if (w) w.style.display = "none";
}
(function wirePopupClose(){
  const okBtn = document.getElementById("ppOk");
  const wrap  = document.getElementById("portalPopup");
  if (okBtn) okBtn.addEventListener("click", hidePopup);
  if (wrap)  wrap.addEventListener("click", (e)=>{ if (e.target && e.target.id === "portalPopup") hidePopup(); });
})();

/* ===== CONFETTI (FULLSCREEN) + MODAL ===== */
let _confettiRAF = null;
let _confettiPieces = [];
let _confettiCtx = null;
let _confettiCanvas = null;
let _confettiOverlay = null;

function openConfetti(title, body){
  const t = document.getElementById("cTitle");
  const b = document.getElementById("cBody");
  if (t) t.textContent = title || "Success ðŸŽ‰";
  if (b) b.innerHTML = nl2br(body || "Done.");
  const modal = document.getElementById("confettiModal");
  if (modal) modal.style.display = "flex";
  startConfetti();
}
function closeConfetti(){
  const modal = document.getElementById("confettiModal");
  if (modal) modal.style.display = "none";
  stopConfetti();
}
function stopConfetti(){
  if (_confettiRAF) cancelAnimationFrame(_confettiRAF);
  _confettiRAF = null;
  _confettiPieces = [];
  if (_confettiCtx && _confettiCanvas){
    try { _confettiCtx.clearRect(0,0,_confettiCanvas.width,_confettiCanvas.height); } catch(_){}
  }
  if (_confettiOverlay) _confettiOverlay.style.display = "none";
}
function startConfetti(){
  _confettiOverlay = document.getElementById("confettiOverlay");
  _confettiCanvas = document.getElementById("confettiCanvas");
  if (!_confettiOverlay || !_confettiCanvas) return;

  _confettiOverlay.style.display = "block";
  _confettiCtx = _confettiCanvas.getContext("2d");

  const colors = ["#ff4d6d","#ffb703","#8ecae6","#219ebc","#8338ec","#3a86ff","#06d6a0","#ffd166","#ef476f","#f72585","#4cc9f0","#b5179e"];

  const resize = () => {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = Math.floor(window.innerWidth * dpr);
    const h = Math.floor(window.innerHeight * dpr);
    if (_confettiCanvas.width !== w || _confettiCanvas.height !== h){
      _confettiCanvas.width = w;
      _confettiCanvas.height = h;
    }
    _confettiCtx.setTransform(dpr,0,0,dpr,0,0);
  };
  resize();

  const W = () => window.innerWidth;
  const H = () => window.innerHeight;

  _confettiPieces = [];
  const count = 260;

  for (let i=0;i<count;i++){
    const size = 3 + Math.random() * 7;
    _confettiPieces.push({
      x: Math.random() * W(),
      y: -60 - Math.random() * H() * 0.9,
      w: size * (0.8 + Math.random()*0.8),
      h: size * (0.8 + Math.random()*1.4),
      vy: 2.2 + Math.random() * 5.8,
      vx: -1.8 + Math.random() * 3.6,
      rot: Math.random() * Math.PI,
      vr: -0.18 + Math.random() * 0.36,
      wob: Math.random() * Math.PI * 2,
      wobSpd: 0.02 + Math.random() * 0.06,
      color: colors[Math.floor(Math.random()*colors.length)],
      alpha: 0.95
    });
  }

  const startAt = performance.now();
  const maxFallTime = 5500;

  const loop = (now) => {
    resize();
    const w = W();
    const h = H();

    _confettiCtx.clearRect(0,0,w,h);

    let stillVisible = false;

    for (const p of _confettiPieces){
      p.wob += p.wobSpd;
      p.x += p.vx + Math.sin(p.wob) * 0.9;
      p.y += p.vy;
      p.rot += p.vr;
      p.vx *= 0.995;

      if (p.y < h + 80) stillVisible = true;

      _confettiCtx.save();
      _confettiCtx.translate(p.x, p.y);
      _confettiCtx.rotate(p.rot);
      _confettiCtx.globalAlpha = p.alpha;
      _confettiCtx.fillStyle = p.color;
      _confettiCtx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      _confettiCtx.restore();
    }

    const elapsed = now - startAt;

    if (elapsed > maxFallTime * 0.75){
      const t = (elapsed - maxFallTime * 0.75) / (maxFallTime * 0.25);
      const fade = Math.max(0, 1 - t);
      for (const p of _confettiPieces) p.alpha = 0.95 * fade;
    }

    if (!stillVisible || elapsed >= maxFallTime || _confettiOverlay.style.display !== "block"){
      stopConfetti();
      return;
    }

    _confettiRAF = requestAnimationFrame(loop);
  };

  if (_confettiRAF) cancelAnimationFrame(_confettiRAF);
  _confettiRAF = requestAnimationFrame(loop);

  window.addEventListener("resize", resize, { passive:true });
}

/* ===== NAME RESOLUTION ===== */
let _studentsCache = null;
async function getStudentsCached(){
  if (_studentsCache) return _studentsCache;
  const resp = await GET({ action:"students" });
  const list = Array.isArray(resp) ? resp : (resp && Array.isArray(resp.students) ? resp.students : []);
  _studentsCache = list;
  return list;
}
function pickBestName(stu, fallbackEmail){
  if (!stu) return String(fallbackEmail||"admin");
  const cand =
    stu.name ||
    stu.full_name || stu.fullName ||
    stu.display_name || stu.displayName ||
    (stu.first_name || stu.firstName || stu.firstname ? `${stu.first_name||stu.firstName||stu.firstname} ${stu.last_name||stu.lastName||stu.lastname||""}`.trim() : "") ||
    "";
  return String(cand || "").trim() || String(fallbackEmail||"admin");
}
async function resolveStudentName(studentIdOrEmail){
  const id = _norm(studentIdOrEmail);
  const students = await getStudentsCached();
  const match = students.find(s => _norm(s.email) === id || _norm(s.student_id) === id);
  return pickBestName(match, studentIdOrEmail);
}

/* ===== CATEGORY â†’ CSS CLASS ===== */
function catClass(cat){
  const c = String(cat || "").toLowerCase();
  if (c.startsWith("social"))   return "cat-gold";
  if (c.startsWith("event"))    return "cat-black";
  if (c.startsWith("meeting"))  return "cat-purple";
  if (c.startsWith("deadline")) return "cat-red";
  return "cat-gold";
}

/* ===== ACTIVE CHECK ===== */
function isActiveEvent(ev){
  const a = ev?.active;
  const s = ev?.status;
  const v = (a != null) ? a : s;
  if (typeof v === "boolean") return v === true;
  return String(v || "").toLowerCase() === "true";
}

/* ===== SHIFTS (cache + UI) â€” FIXED + HARDENED ===== */
const shiftsCacheByEvent = new Map();       // event_id -> array of shifts
const shiftMapById = new Map();            // shift_id -> shift object
const shiftLabelById = new Map();          // shift_id -> pretty label (for display)

/** Normalize whatever the script returns into a plain shift array */
function normalizeShiftsResp(resp){
  if (!resp) return [];
  if (Array.isArray(resp)) return resp;

  if (Array.isArray(resp.shifts)) return resp.shifts;
  if (Array.isArray(resp.rows)) return resp.rows;
  if (Array.isArray(resp.data)) return resp.data;

  if (resp.data && Array.isArray(resp.data.shifts)) return resp.data.shifts;
  if (resp.result && Array.isArray(resp.result.shifts)) return resp.result.shifts;

  return [];
}

/** Try to pull shifts off the event object itself if no endpoint exists */
function shiftsFromEventObject(eventId){
  const evId = String(eventId || "").trim();
  if (!evId) return [];

  const ev = (eventsCache || []).find(e => String(e.event_id || e.id || "").trim() === evId) || null;
  if (!ev) return [];

  // Common shapes people store:
  // ev.shifts = [...] or ev.shifts_json = "[...]"
  let raw = ev.shifts ?? ev.shift_list ?? ev.shiftList ?? ev.shifts_data ?? ev.shiftsData ?? null;

  if (!raw && typeof ev.shifts_json === "string") raw = ev.shifts_json;
  if (!raw && typeof ev.shiftsJson === "string") raw = ev.shiftsJson;

  // If it's a JSON string, parse it
  if (typeof raw === "string"){
    const s = raw.trim();
    if (!s) return [];
    try { raw = JSON.parse(s); } catch(_) { return []; }
  }

  if (!Array.isArray(raw)) return [];

  // Coerce into shift objects
  return raw.map((s, i)=>({
    ...s,
    shift_id: String(s.shift_id ?? s.shiftId ?? s.id ?? `${evId}_shift_${i+1}`).trim(),
    event_id: String(s.event_id ?? s.eventId ?? evId).trim()
  })).filter(s=>s.shift_id);
}

/** Load shifts for event, with aggressive fallback action names + event-object fallback */
async function loadShiftsForEvent(eventId){
  const evId = String(eventId || "").trim();
  if (!evId) return [];

  if (shiftsCacheByEvent.has(evId)) return shiftsCacheByEvent.get(evId) || [];

  // 1) Try server endpoints
  const resp = await GET_tryActions(
    [
      "shifts",
      "eventshifts",
      "event_shifts",
      "getshifts",
      "get_shifts",
      "shifts_by_event",
      "shiftsByEvent"
    ],
    { event_id: evId }
  );

  let list = normalizeShiftsResp(resp);

  // 2) If server gave nothing, fall back to shifts embedded on the event object
  if (!list || !list.length){
    list = shiftsFromEventObject(evId);
  }

  const cleaned = (list || []).map(s => {
    const sid = String(s.shift_id ?? s.shiftId ?? s.id ?? "").trim();
    return { ...s, shift_id: sid, event_id: String(s.event_id ?? s.eventId ?? evId).trim() };
  }).filter(s => s.shift_id);

  shiftsCacheByEvent.set(evId, cleaned);

  cleaned.forEach(s=>{
    shiftMapById.set(s.shift_id, s);
    shiftLabelById.set(s.shift_id, shiftLabel(s));
  });

  return cleaned;
}



/** does event require a shift selection? */
function mustPickShiftForEvent(eventId){
  const ev = (eventsCache || []).find(e => String(e.event_id||"").trim() === String(eventId||"").trim()) || null;
  return isTrue(ev?.shifts_required) === true;
}

/** Populate a shift dropdown for a given prefix (req/su) */
async function setShiftUI(prefix, eventId){
  const wrap = document.getElementById(prefix + "ShiftWrap");
  const sel  = document.getElementById(prefix + "Shift");
  const hint = document.getElementById(prefix + "ShiftHint");
  if (!wrap || !sel) return;

  sel.innerHTML = "";
  if (hint) hint.textContent = "";

  const evId = String(eventId || "").trim();
  if (!evId){
    wrap.style.display = "none";
    return;
  }

  // Always attempt load
  const shifts = await loadShiftsForEvent(evId);

  // If no shifts, hide UI
  if (!shifts.length){
    wrap.style.display = "none";
    return;
  }

  wrap.style.display = "block";

  const required = mustPickShiftForEvent(evId);

  // placeholder option
  if (required){
    sel.appendChild(new Option("Select a shiftâ€¦", ""));
  } else {
    sel.appendChild(new Option("No shift (not required)", ""));
  }

  shifts.forEach(s=>{
    sel.appendChild(new Option(shiftLabelById.get(s.shift_id) || shiftLabel(s), s.shift_id));
  });

  if (hint){
    hint.textContent = required
      ? "Shift selection is required for this event."
      : "Optional â€” pick a shift if you want your sign-up/request tied to a specific shift.";
  }
}

/** Modal shift UI */
async function setModalShiftUI(eventId){
  const wrap = document.getElementById("mShiftWrap");
  const sel  = document.getElementById("mShift");
  const hint = document.getElementById("mShiftHint");
  if (!wrap || !sel) return;

  sel.innerHTML = "";
  if (hint) hint.textContent = "";

  const evId = String(eventId || "").trim();
  if (!evId){
    wrap.style.display = "none";
    return;
  }

  const shifts = await loadShiftsForEvent(evId);

  if (!shifts.length){
    wrap.style.display = "none";
    return;
  }

  wrap.style.display = "block";
  const required = mustPickShiftForEvent(evId);

  if (required){
    sel.appendChild(new Option("Select a shiftâ€¦", ""));
  } else {
    sel.appendChild(new Option("No shift (not required)", ""));
  }

  shifts.forEach(s=>{
    sel.appendChild(new Option(shiftLabelById.get(s.shift_id) || shiftLabel(s), s.shift_id));
  });

  if (hint){
    hint.textContent = required
      ? "Shift selection is required for this event."
      : "Optional â€” pick a shift if you want this tied to a shift.";
  }
}

/** Get selected shift (req/su) */
function getSelectedShift(prefix){
  const wrap = document.getElementById(prefix + "ShiftWrap");
  const sel  = document.getElementById(prefix + "Shift");
  if (!wrap || !sel || wrap.style.display === "none") return null;
  const v = String(sel.value || "").trim();
  return v || null;
}

/** Get selected shift from modal */
function modalSelectedShift(){
  const wrap = document.getElementById("mShiftWrap");
  const sel  = document.getElementById("mShift");
  if (!wrap || !sel || wrap.style.display === "none") return null;
  const v = String(sel.value || "").trim();
  return v || null;
}

/** Helper: attach extra shift fields to a payload so Apps Script can write them */
function attachShiftToPayload(payload, shiftId){
  const sid = String(shiftId || "").trim();
  if (!sid){
    // also send explicit empties so sheet columns can be cleared if you want
    return { ...payload, shift_id:"", shiftId:"", shift:"", shift_label:"", shift_start:"", shift_end:"" };
  }

  const s = shiftMapById.get(sid) || null;
  const label = shiftLabelById.get(sid) || (s ? shiftLabel(s) : sid);

  const start = s?.start || s?.shift_start || "";
  const end   = s?.end   || s?.shift_end   || "";

  return {
    ...payload,
    // send in multiple keys so your backend catches at least one
    shift_id: sid,
    shiftId: sid,
    shift: sid,
    shift_label: label,
    shiftLabel: label,
    shift_start: start,
    shift_end: end
  };
}



/* ===== SHIFT EDITOR (Create/Edit) ===== */
let _shiftEditorWired = false;
let _shiftEditorRemoveAllFlag = false;

function wireShiftEditor(){
  if (_shiftEditorWired) return;
  _shiftEditorWired = true;

  const has = document.getElementById("ev_hasShifts");
  const box = document.getElementById("ev_shiftsBox");
  const add = document.getElementById("ev_addShift");
  const remAll = document.getElementById("ev_removeAllShifts");

  if (!has || !box || !add || !remAll) return;

  const setVisible = (on)=>{
    box.style.display = on ? "block" : "none";
    add.style.display = on ? "inline-flex" : "none";
    remAll.style.display = on ? "inline-flex" : "none";
    if (!on){
      _shiftEditorRemoveAllFlag = false;
    }
  };

  has.addEventListener("change", ()=> setVisible(has.checked));
  add.addEventListener("click", ()=> addShiftRow());

  remAll.addEventListener("click", ()=>{
    const tbody = document.getElementById("ev_shiftsBody");
    if (tbody) tbody.innerHTML = "";
    _shiftEditorRemoveAllFlag = true;
    const st = document.getElementById("ev_shiftStatus");
    if (st) st.textContent = "All shift rows removed. Save Event to apply this change.";
  });

  setVisible(false);
}

function addShiftRow(data){
  const tbody = document.getElementById("ev_shiftsBody");
  if (!tbody) return;

  const title = String(data?.title ?? data?.name ?? "").trim();
  const start = data?.start ? toLocalInput(data.start) : (data?.start_local || "");
  const end   = data?.end ? toLocalInput(data.end) : (data?.end_local || "");
  const cap   = (data?.capacity != null && data?.capacity !== "") ? Number(data.capacity) : 0;
  const active = (data?.active == null) ? true : isTrue(data.active);

  // âœ… preserve existing shift_id when editing
  const sid = String(data?.shift_id ?? data?.shiftId ?? data?.id ?? "").trim();

  const tr = document.createElement("tr");
  tr.dataset.shiftId = sid; // store on row (blank for brand-new shift)

  tr.innerHTML = `
    <td><input type="text" data-k="title" placeholder="e.g., Setup / Check-in" value="${esc(title)}"></td>
    <td><input type="datetime-local" data-k="start" value="${esc(start)}"></td>
    <td><input type="datetime-local" data-k="end" value="${esc(end)}"></td>
    <td><input type="number" data-k="capacity" value="${esc(String(isFinite(cap)?cap:0))}" min="0"></td>
    <td style="text-align:left;">
      <label style="display:flex;align-items:center;gap:8px;margin:0;">
        <input type="checkbox" data-k="active" ${active ? "checked" : ""} style="width:auto;">
        <span class="muted small">active</span>
      </label>
    </td>
    <td><button type="button" class="secondary" data-act="rm">Remove</button></td>
  `;
  tr.querySelector('[data-act="rm"]')?.addEventListener("click", ()=> tr.remove());
  tbody.appendChild(tr);

  _shiftEditorRemoveAllFlag = false;
  const st = document.getElementById("ev_shiftStatus");
  if (st) st.textContent = "Editing shiftsâ€¦";
}


function setShiftEditorFromEvent(eventId, shifts, shiftsRequired){
  const has = document.getElementById("ev_hasShifts");
  const req = document.getElementById("ev_shiftsRequired");
  const box = document.getElementById("ev_shiftsBox");
  const add = document.getElementById("ev_addShift");
  const remAll = document.getElementById("ev_removeAllShifts");
  const tbody = document.getElementById("ev_shiftsBody");
  const st = document.getElementById("ev_shiftStatus");

  if (!has || !req || !box || !tbody || !add || !remAll) return;

  const shouldEnable = !!(shiftsRequired || (Array.isArray(shifts) && shifts.length));
  has.checked = shouldEnable;
  box.style.display = shouldEnable ? "block" : "none";
  add.style.display = shouldEnable ? "inline-flex" : "none";
  remAll.style.display = shouldEnable ? "inline-flex" : "none";
  req.checked = !!shiftsRequired;

  tbody.innerHTML = "";
  _shiftEditorRemoveAllFlag = false;

  if (Array.isArray(shifts) && shifts.length){
    shifts.forEach(s=> addShiftRow(s));
    if (st) st.textContent = `Loaded ${shifts.length} shift(s).`;
  } else {
    if (st) st.textContent = shouldEnable ? "No shifts loaded yet. Add shifts if needed." : "";
  }
}

function readShiftEditor(){
  const has = document.getElementById("ev_hasShifts");
  const req = document.getElementById("ev_shiftsRequired");
  const tbody = document.getElementById("ev_shiftsBody");
  const evId = String(document.getElementById("ev_id")?.value || "").trim();

  const enabled = !!(has && has.checked);
  const required = !!(req && req.checked);
  if (!enabled) return { enabled:false, required:false, shifts:[], removeAll:false };

  const rows = tbody ? [...tbody.querySelectorAll("tr")] : [];
  let autoIdx = 0;

  const shifts = rows.map(tr=>{
    const title = tr.querySelector('[data-k="title"]')?.value || "";
    const startLocal = tr.querySelector('[data-k="start"]')?.value || "";
    const endLocal   = tr.querySelector('[data-k="end"]')?.value || "";
    const capacity = Number(tr.querySelector('[data-k="capacity"]')?.value || 0);
    const active = !!tr.querySelector('[data-k="active"]')?.checked;

    const any = (String(title).trim() || startLocal || endLocal || (Number(capacity)||0) > 0);
    if (!any) return null;

    // âœ… Keep existing shift_id if present, else stable auto
    let sid = String(tr.dataset.shiftId || "").trim();
    if (!sid){
      sid = makeAutoShiftId(evId || "EVT", autoIdx);
      autoIdx++;
    }

    return {
      shift_id: sid,
      title: String(title).trim(),
      start: startLocal ? new Date(startLocal).toISOString() : "",
      end: endLocal ? new Date(endLocal).toISOString() : "",
      capacity: isFinite(capacity) ? capacity : 0,
      active
    };
  }).filter(Boolean);

  return { enabled:true, required, shifts, removeAll: !!_shiftEditorRemoveAllFlag };
}


function clearShiftEditorUI(){
  const has = document.getElementById("ev_hasShifts");
  const req = document.getElementById("ev_shiftsRequired");
  const box = document.getElementById("ev_shiftsBox");
  const add = document.getElementById("ev_addShift");
  const remAll = document.getElementById("ev_removeAllShifts");
  const tbody = document.getElementById("ev_shiftsBody");
  const st = document.getElementById("ev_shiftStatus");

  if (has) has.checked = false;
  if (req) req.checked = false;
  if (box) box.style.display = "none";
  if (add) add.style.display = "none";
  if (remAll) remAll.style.display = "none";
  if (tbody) tbody.innerHTML = "";
  if (st) st.textContent = "";
  _shiftEditorRemoveAllFlag = false;
}

/* ===== STATE ===== */
let currentAdminId = null;
let eventsCache = [];
let activeEventsCache = [];
let calendarInstance = null;

/* ===== Event ID auto-fill ===== */
function nextEventIdFromCache(){
  const ids = (eventsCache || [])
    .map(ev => String(ev?.event_id ?? ev?.id ?? ev?.eventId ?? "").trim())
    .filter(Boolean);

  if (!ids.length) return "EVT001";

  let bestPrefix = "EVT";
  let maxNum = 0;
  let found = false;

  for (const id of ids){
    const m = id.match(/^([A-Za-z]+)(\d+)$/);
    if (!m) continue;
    const prefix = m[1];
    const num = parseInt(m[2], 10);
    if (!isFinite(num)) continue;
    if (!found){
      bestPrefix = prefix || bestPrefix;
      maxNum = num;
      found = true;
    } else if (num > maxNum){
      maxNum = num;
      bestPrefix = prefix || bestPrefix;
    }
  }

  if (!found) return "EVT001";

  const next = maxNum + 1;
  const padded = String(next).padStart(3, "0");
  return `${bestPrefix}${padded}`;
}
function autofillEventIdIfEmpty(){
  const el = document.getElementById("ev_id");
  if (!el) return;
  if (String(el.value || "").trim() !== "") return;
  el.value = nextEventIdFromCache();
}

/* ===== BOOT (WRAPPED) ===== */
(async function(){
  try{
    const meHoursSub = document.getElementById("meHoursSub");
    if (meHoursSub) meHoursSub.textContent = CURRENT_SEMESTER;

    const sess = getSession();
    currentAdminId = String(sess.username || sess.student_id || sess.studentId || sess.email || "").trim();

    if (!currentAdminId){
      const g = document.getElementById("adminGreet");
      const n = document.getElementById("adminName");
      if (g) g.textContent = "Session expired";
      if (n) n.textContent = "Please go back and log in again.";
      return;
    }

    const g = document.getElementById("adminGreet");
    const n = document.getElementById("adminName");
    if (g) g.textContent = greetingForNow();
    if (n) n.textContent = await resolveStudentName(currentAdminId);

    wireShiftEditor();

    const evResp = await GET_tryActions(["events","getevents","get_events","listevents","list_events"], {});
    eventsCache = Array.isArray(evResp) ? evResp
      : (evResp && Array.isArray(evResp.events) ? evResp.events
        : (evResp?.data?.events || []));

    activeEventsCache = (eventsCache || []).filter(isActiveEvent);

    fillEventSelects(activeEventsCache);
    buildCalendar(activeEventsCache);

    const reqSel = document.getElementById("reqEvent");
    const suSel  = document.getElementById("signupEvent");
    const reqFirst = reqSel ? (reqSel.value || "") : "";
    const suFirst  = suSel ? (suSel.value || "") : "";

    if (reqSel) reqSel.addEventListener("change", async (e)=> setShiftUI("req", e.target.value));
    if (suSel)  suSel.addEventListener("change", async (e)=> setShiftUI("su", e.target.value));

    if (reqFirst) await loadShiftsForEvent(reqFirst);
    if (suFirst)  await loadShiftsForEvent(suFirst);

    await setShiftUI("req", reqFirst);
    await setShiftUI("su", suFirst);

    autofillEventIdIfEmpty();

    initReqAdmin();
    initPendingCenter(activeEventsCache);

    const saveBtn = document.getElementById("saveEventBtn");
    if (saveBtn) saveBtn.addEventListener("click", saveEvent);

    const meRefresh = document.getElementById("btnMeRefresh");
    if (meRefresh) meRefresh.addEventListener("click", refreshMe);

    const formReq = document.getElementById("formRequest");
    if (formReq) formReq.addEventListener("submit", submitMyRequest);

    const formSu = document.getElementById("formSignup");
    if (formSu) formSu.addEventListener("submit", submitMySignup);

    await refreshMe();
  }catch(err){
    console.error("BOOT failed:", err);
    showPopup(false, "Startup error", String(err?.message || err));
  }
})();





/* ===== Quick actions ===== */
function fillEventSelects(activeEvents){
  const reqSel = document.getElementById("reqEvent");
  const btnReq = document.getElementById("btnReq");

  const reqList = [...(activeEvents||[])].sort((a,b)=>{
    const ta = Date.parse(a.start); const tb = Date.parse(b.start);
    if (isNaN(ta) && isNaN(tb)) return 0;
    if (isNaN(ta)) return 1;
    if (isNaN(tb)) return -1;
    return tb - ta;
  });

  reqSel.innerHTML = "";
  if (!reqList.length){
    reqSel.appendChild(new Option("No active events available",""));
    reqSel.disabled = true; btnReq.disabled = true;
  } else {
    reqSel.disabled = false; btnReq.disabled = false;
    reqList.forEach(ev => reqSel.appendChild(new Option(`${ev.title} â€” ${fmtDate(ev.start)}`, ev.event_id)));
  }

  const suSel  = document.getElementById("signupEvent");
  const btnSu  = document.getElementById("btnSignup");
  const now = Date.now();
  const upcoming = (activeEvents||[]).filter(ev => {
    const t = Date.parse(ev.start);
    return !isNaN(t) && t >= now - 86400000;
  }).sort((a,b)=>Date.parse(a.start)-Date.parse(b.start));

  suSel.innerHTML = "";
  if (!upcoming.length){
    suSel.appendChild(new Option("No upcoming events",""));
    suSel.disabled = true; btnSu.disabled = true;
  } else {
    suSel.disabled = false; btnSu.disabled = false;
    upcoming.forEach(ev => {
      const capTxt = ev.signup_capacity ? ` (${ev.signup_capacity} cap)` : "";
      suSel.appendChild(new Option(`${ev.title} â€” ${fmtDate(ev.start)}${capTxt}`, ev.event_id));
    });
  }
}

async function submitMyRequest(e){
  e.preventDefault();
  const msgEl = document.getElementById("msgReq");
  msgEl.textContent = "";

  const evId = document.getElementById("reqEvent").value;
  if (!evId){
    toast(msgEl, false, "Please choose an event.");
    return;
  }

  const shiftIdRaw = getSelectedShift("req");
  const shiftId = (shiftIdRaw && String(shiftIdRaw).trim()) ? String(shiftIdRaw).trim() : null;

  if (mustPickShiftForEvent(evId) && !shiftId){
    toast(msgEl, false, "Please select a shift.");
    showPopup(false, "Missing shift", "This event requires a shift selection.");
    return;
  }

  const btn = document.getElementById("btnReq");
  btn.disabled = true;
  toast(msgEl, true, "Submittingâ€¦");

  const requestedHours = safeHours(document.getElementById("reqHours").value);

  const out = await POST_tryActions(
    ["request","attendance_request","submitrequest","submit_request","newrequest","new_request"],
    {
      student_id: currentAdminId,
      event_id: evId,

      // âœ… do NOT send "" â€” send null (or omit)
      shift_id: shiftId,
      // âœ… compatibility aliases (harmless if ignored)
      shift: shiftId,
      shiftId: shiftId,

      requested_hours: requestedHours,
      comment: (document.getElementById("reqComment").value || "").trim(),
      notify: true,
      source: "portal_admin",
      current_semester: CURRENT_SEMESTER
    }
  );

  if (out && out.ok){
    toast(msgEl, true, "Request submitted!");
    openConfetti(
      "Request submitted",
      requestedHours == null
        ? "Your attendance request was submitted."
        : `Your attendance request was submitted.\nRequested hours: ${requestedHours}`
    );
    document.getElementById("reqHours").value = "";
    document.getElementById("reqComment").value = "";
    await refreshMe();
    try{ document.getElementById("pcRefresh")?.click(); }catch(_){}
  } else {
    const err = (out && (out.error || out.message)) || "Request failed";
    toast(msgEl, false, err);
    showPopup(false, "Request failed", err);
    if (out && out.body) console.log("POST body:", out.body);
  }

  btn.disabled = false;
}

async function submitMySignup(e){
  e.preventDefault();
  const msgEl = document.getElementById("msgSignup");
  msgEl.textContent = "";

  const evId = document.getElementById("signupEvent").value;
  if (!evId){
    toast(msgEl, false, "Please choose an event.");
    return;
  }

  const shiftIdRaw = getSelectedShift("su");
  const shiftId = (shiftIdRaw && String(shiftIdRaw).trim()) ? String(shiftIdRaw).trim() : null;

  if (mustPickShiftForEvent(evId) && !shiftId){
    toast(msgEl, false, "Please select a shift.");
    showPopup(false, "Missing shift", "This event requires a shift selection.");
    return;
  }

  const btn = document.getElementById("btnSignup");
  btn.disabled = true;
  toast(msgEl, true, "Submittingâ€¦");

  const requestedHours = safeHours(document.getElementById("suHours").value);

  const out = await POST_tryActions(
    ["signup","event_signup","sign_up","submitSignup","submit_signup","newsignup","new_signup"],
    {
      student_id: currentAdminId,
      event_id: evId,

      // âœ… do NOT send "" â€” send null (or omit)
      shift_id: shiftId,
      // âœ… compatibility aliases
      shift: shiftId,
      shiftId: shiftId,

      created_by: "admin",
      requested_hours: requestedHours,
      comment: (document.getElementById("suComment").value || "").trim(),
      notify: true,
      source: "portal_admin",
      current_semester: CURRENT_SEMESTER
    }
  );

  if (out && out.ok){
    const statusTxt = out.status === "accepted" ? "confirmed âœ…" : "submitted âœ…";
    toast(msgEl, true, `Sign-up ${statusTxt}`);
    openConfetti(
      "Signed up",
      requestedHours == null
        ? `You are ${statusTxt}.`
        : `You are ${statusTxt}.\nRequested hours: ${requestedHours}`
    );
    document.getElementById("suHours").value = "";
    document.getElementById("suComment").value = "";
    await refreshMe();
  } else {
    const err = (out && (out.error || out.message)) || "Sign-up failed";
    toast(msgEl, false, err);
    showPopup(false, "Sign-up failed", err);
    if (out && out.body) console.log("POST body:", out.body);
  }

  btn.disabled = false;
}



/* =========================
   MY HISTORY
   ========================= */
let _meHistAttendance = [];
let _meHistRequests = [];
let _meHistFull = [];
let _meHistWired = false;

function meHist_cleanSemesterLabel(x){
  const s = String(x || "").trim();
  return s || "Unknown";
}
function meHist_hoursNum(v){
  const n = Number(v);
  return isFinite(n) ? n : 0;
}
function meHist_normalizeStatus(raw){
  const s = String(raw ?? "").trim().toLowerCase();
  if (s.includes("pend")) return "pending";
  if (s.includes("deny") || s.includes("reject")) return "denied";
  if (s.includes("approv") || s.includes("accept")) return "approved";
  return s;
}
function meHist_statusIconForRow(row){
  if (row?._type === "attendance") return "âœ…";
  const s = meHist_normalizeStatus(row.status || row.request_status || row.state);
  if (s === "pending") return "âš ï¸";
  if (s === "denied") return "âŒ";
  if (s === "approved") return "âœ…";
  return "âš ï¸";
}
function meHist_rowSemester(row){
  return meHist_cleanSemesterLabel(row.semester_id || row.semester || row.current_semester || "");
}
function meHist_rowEventTitle(row){
  const base = row.event_title || row.title || "â€”";
  const sid = String(row.shift_id ?? row.shiftId ?? "").trim();
  const sl = sid ? (shiftLabelById.get(sid) || sid) : "";
  return sl ? `${base} (shift: ${sl})` : base;
}
function meHist_rowEventStart(row){
  return row.event_start || row.start || row.event_date || row.created_at || row.timestamp || "";
}
function meHist_rowEventDateForDisplay(row){
  const dt = meHist_rowEventStart(row);
  return dt ? new Date(dt).toLocaleDateString() : "â€”";
}
function meHist_rowHoursForDisplay(row){
  return row._type === "attendance"
    ? meHist_hoursNum(row.hours_awarded ?? row.hours ?? row.awarded_hours ?? 0)
    : meHist_hoursNum(row.requested_hours ?? row.hours_requested ?? row.hours ?? 0);
}
function meHist_rowComment(row){
  return row.comments || row.comment || row.notes || "";
}
function meHist_renderHistory(semester){
  const tbody = document.getElementById("histRows");
  if (!tbody) return;

  tbody.innerHTML = "";

  const rows = (_meHistFull || []).filter(r => meHist_rowSemester(r) === semester);

  if (!rows.length){
    tbody.innerHTML = `<tr><td colspan="6" class="muted small">No history in this semester.</td></tr>`;
    return;
  }

  rows.sort((a,b)=>Date.parse(meHist_rowEventStart(b)||0)-Date.parse(meHist_rowEventStart(a)||0));

  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="tag">${esc(meHist_rowSemester(r))}</span></td>
      <td>${esc(meHist_rowEventTitle(r))}</td>
      <td>${esc(meHist_rowEventDateForDisplay(r))}</td>
      <td>${esc(String(meHist_rowHoursForDisplay(r)))}</td>
      <td>${esc(meHist_statusIconForRow(r))}</td>
      <td>${esc(meHist_rowComment(r))}</td>
    `;
    tbody.appendChild(tr);
  });
}

async function meHist_getMyRequests(){
  const resp = await GET_tryActions(
    ["myrequests","requests_by_student","requests","requesthistory","history_requests","attendance_requests"],
    { student_id: currentAdminId }
  );

  if (resp && resp.ok === false && (resp.error || resp.message)){
    return { ok:false, error: resp.error || resp.message || "Failed to load requests", rows: [] };
  }

  const rows = normalizePending(resp);
  return { ok:true, rows: rows || [] };
}

async function refreshMe(){
  const msgHist = document.getElementById("msgHist");
  if (msgHist) msgHist.textContent = "";

  const hist = await GET({ action:"attendance", student_id: currentAdminId });
  const attRows = normalizeAttendanceList(hist);

  _meHistAttendance = (attRows || []).map(r=>{
    const ev = (eventsCache || []).find(e => String(e.event_id||"").trim() === String(r.event_id||r.eventId||"").trim()) || null;
    const sem = String(r.semester_id || r.semester || r.current_semester || "").trim() || String(CURRENT_SEMESTER);
    return {
      ...r,
      _type: "attendance",
      status: "approved",
      semester_id: sem,
      event_title: r.event_title || ev?.title || r.title || r.event_id || "â€”",
      event_start: r.event_start || ev?.start || r.start || r.recorded_at || ""
    };
  });

  const reqResp = await meHist_getMyRequests();
  _meHistRequests = (reqResp.ok ? reqResp.rows : []).map(r=>{
    const evId = String(r.event_id ?? r.eventId ?? r.event ?? "").trim();
    const ev = (eventsCache || []).find(e => String(e.event_id||"").trim() === evId) || null;
    const sem = String(r.semester_id || r.semester || r.current_semester || "").trim() || (ev?.semester_id || CURRENT_SEMESTER);
    return {
      ...r,
      _type: "request",
      semester_id: sem,
      event_title: r.event_title || ev?.title || r.title || evId || "â€”",
      event_start: r.event_start || ev?.start || r.start || r.created_at || ""
    };
  });

  _meHistFull = [..._meHistAttendance, ..._meHistRequests];

  const semAtt = _meHistAttendance.filter(r => meHist_rowSemester(r) === CURRENT_SEMESTER);
  const semTotal = semAtt.reduce((acc,r)=> acc + meHist_hoursNum(r.hours_awarded ?? r.hours ?? r.awarded_hours ?? 0), 0);
  document.getElementById("meHoursTotal").textContent = (Math.round(semTotal*100)/100).toString();
  document.getElementById("meHoursSub").textContent = CURRENT_SEMESTER;

  const allTotal = _meHistAttendance.reduce((acc,r)=> acc + meHist_hoursNum(r.hours_awarded ?? r.hours ?? r.awarded_hours ?? 0), 0);

  const semSet = new Set((_meHistFull || []).map(meHist_rowSemester));
  semSet.add(CURRENT_SEMESTER);
  const semesters = [...semSet].filter(Boolean);

  function semMaxDate(sem){
    const rows = (_meHistFull || []).filter(r => meHist_rowSemester(r) === sem);
    let best = 0;
    rows.forEach(r=>{
      const t = Date.parse(meHist_rowEventStart(r) || "");
      if (!isNaN(t) && t > best) best = t;
    });
    return best || 0;
  }
  semesters.sort((a,b)=>{
    if (a === CURRENT_SEMESTER && b !== CURRENT_SEMESTER) return -1;
    if (b === CURRENT_SEMESTER && a !== CURRENT_SEMESTER) return 1;
    return semMaxDate(b) - semMaxDate(a);
  });

  const sel = document.getElementById("histSem");
  if (sel){
    const current = sel.value || CURRENT_SEMESTER;
    sel.innerHTML = semesters.map(s => `<option value="${esc(s)}">${esc(s)}</option>`).join("");
    sel.value = semesters.includes(current) ? current : CURRENT_SEMESTER;

    if (!_meHistWired){
      sel.addEventListener("change", ()=>{
        const chosen = sel.value;
        const semApproved = _meHistAttendance.filter(r => meHist_rowSemester(r) === chosen);
        const semTot = semApproved.reduce((acc,r)=> acc + meHist_hoursNum(r.hours_awarded ?? r.hours ?? r.awarded_hours ?? 0), 0);
        document.getElementById("histSemTotal").textContent = (Math.round(semTot*100)/100).toString();
        document.getElementById("histAllTotal").textContent = (Math.round(allTotal*100)/100).toString();
        meHist_renderHistory(chosen);
      });
      _meHistWired = true;
    }

    const chosen = sel.value || CURRENT_SEMESTER;
    const chosenApproved = _meHistAttendance.filter(r => meHist_rowSemester(r) === chosen);
    const chosenTot = chosenApproved.reduce((acc,r)=> acc + meHist_hoursNum(r.hours_awarded ?? r.hours ?? r.awarded_hours ?? 0), 0);

    document.getElementById("histSemTotal").textContent = (Math.round(chosenTot*100)/100).toString();
    document.getElementById("histAllTotal").textContent = (Math.round(allTotal*100)/100).toString();
    meHist_renderHistory(chosen);
  }

  if (!reqResp.ok && msgHist){
    msgHist.className = "msg err";
    msgHist.textContent = `Requests not loading: ${reqResp.error || "unknown error"}`;
  } else if (msgHist){
    msgHist.className = "msg";
    msgHist.textContent = "";
  }
}

/* ===== Calendar ===== */
function buildCalendar(events){
  const el = document.getElementById("calendar");
  if (!el) return;
  if (!window.FullCalendar || !window.FullCalendar.Calendar){
    return setTimeout(() => buildCalendar(events), 150);
  }

  const fcEvents = (events || []).map(ev => {
    const category = ev.category || ev.type || "";
    return {
      id: String(ev.event_id),
      title: ev.title,
      start: ev.start,
      end: ev.end || null,
      classNames: [catClass(category)],
      extendedProps: { ...ev, category }
    };
  });

  const desiredView = isMobileCal() ? "listWeek" : "dayGridMonth";
  const desiredRight = isMobileCal()
    ? "listWeek,dayGridMonth"
    : "dayGridMonth,timeGridWeek,timeGridDay,listWeek";

  if (calendarInstance){
    calendarInstance.removeAllEvents();
    fcEvents.forEach(evt => calendarInstance.addEvent(evt));
    const currentView = calendarInstance.view && calendarInstance.view.type;
    if (currentView !== desiredView) calendarInstance.changeView(desiredView);
    calendarInstance.setOption("headerToolbar", { left:"prev,next today", center:"title", right:desiredRight });
    calendarInstance.render();
    return;
  }

  calendarInstance = new FullCalendar.Calendar(el, {
    initialView: desiredView,
    height: "auto",
    headerToolbar: { left:"prev,next today", center:"title", right: desiredRight },
    events: fcEvents,

    views: {
      dayGridMonth: { eventDisplay: "list-item" },
      listWeek:     { eventDisplay: "auto" },
      timeGridWeek: { eventDisplay: "block" },
      timeGridDay:  { eventDisplay: "block" }
    },

    nowIndicator: true,
    navLinks: true,
    dayMaxEvents: true,

    eventClassNames: (arg) => [catClass(arg?.event?.extendedProps?.category)],
    eventDidMount: (arg) => { try { arg.el.classList.add(catClass(arg.event.extendedProps?.category)); } catch(_) {} },

    windowResize: () => {
      try{
        const v = isMobileCal() ? "listWeek" : "dayGridMonth";
        const r = isMobileCal()
          ? "listWeek,dayGridMonth"
          : "dayGridMonth,timeGridWeek,timeGridDay,listWeek";
        if (calendarInstance.view.type !== v) calendarInstance.changeView(v);
        calendarInstance.setOption("headerToolbar", { left:"prev,next today", center:"title", right:r });
      }catch(_){}
    },

    eventClick: async (info) => {
      const ev = info.event.extendedProps || {};
      const eventId = info.event.id;

      const roster = await GET_tryActions(
        ["eventroster","roster","event_roster","getroster","get_roster"],
        { event_id: eventId }
      );

      await loadShiftsForEvent(eventId);

      openModal({
        ev,
        roster,
        approved: extractApproved(roster),
        signupsAccepted: extractSignupsAccepted(roster),
        signupsWait: extractSignupsWait(roster)
      });
    }
  });

  calendarInstance.render();
}

/* Roster extractors */
function extractApproved(roster){
  if (!roster) return [];
  if (Array.isArray(roster.approved)) return roster.approved;
  if (roster.attendance && Array.isArray(roster.attendance.approved)) return roster.attendance.approved;
  if (roster.attendance && Array.isArray(roster.attendance)) return roster.attendance;
  if (Array.isArray(roster.rows)) return roster.rows;
  return [];
}
function extractSignupsAccepted(roster){
  if (!roster) return [];
  if (roster.signups && Array.isArray(roster.signups.accepted)) return roster.signups.accepted;
  if (roster.signups && Array.isArray(roster.signups)) return roster.signups;
  return [];
}
function extractSignupsWait(roster){
  if (!roster) return [];
  if (roster.signups && Array.isArray(roster.signups.waitlisted)) return roster.signups.waitlisted;
  if (roster.signups && Array.isArray(roster.signups.waitlist)) return roster.signups.waitlist;
  if (roster.signups && Array.isArray(roster.signups.waitlisted_rows)) return roster.signups.waitlisted_rows;
  return [];
}

/* ===== Modal ===== */
let _modalEventId = null;
function openModal(data){
  const ev = data.ev || {};
  _modalEventId = String(ev.event_id || ev.id || "");

  const approved = data.approved || [];
  const sAcc = data.signupsAccepted || [];
  const sWait = data.signupsWait || [];

  document.getElementById("mTitle").textContent = ev.title || ev.event_id || "Event";
  document.getElementById("mWhen").textContent  = `${fmtDate(ev.start)}${ev.end ? (" â†’ " + fmtDate(ev.end)) : ""}`;
  document.getElementById("mWhere").textContent = ev.location ? `Location: ${ev.location}` : "";
  const desc = ev.description || ev.details || ev.notes || "";
  document.getElementById("mDesc").textContent = desc ? `Description: ${desc}` : "";

  const capEl = document.getElementById("mCap");
  const limit = Number(ev.signup_capacity || 0);
  capEl.textContent = limit > 0 ? `Sign-ups: ${sAcc.length} / ${limit}` : `Sign-ups: ${sAcc.length} (no cap)`;

  /* FIX: populate modal shifts reliably */
  setModalShiftUI(_modalEventId);

  document.getElementById("mMyHours").value = "";
  document.getElementById("mMyComment").value = "";
  document.getElementById("mMyStatus").textContent = "";

  document.getElementById("mBtnSignupMe").onclick = () => modalSignupMe(_modalEventId);
  document.getElementById("mBtnRequestMe").onclick = () => modalRequestMe(_modalEventId);

  const aUL = document.getElementById("mApproved");
  aUL.innerHTML = "";
  approved.forEach(a => {
    const li = document.createElement("li");
    const hrs = (Number(a.hours_awarded) > 0) ? ` Â· Hours: ${a.hours_awarded}` : "";
    const cmt = (a.comments || a.comment) ? ` â€” ${(a.comments || a.comment)}` : "";
    const sid = String(a.shift_id ?? a.shiftId ?? "").trim();
    const sLab = sid ? (shiftLabelById.get(sid) || sid) : "";
    const sTxt = sLab ? ` Â· Shift: ${sLab}` : "";
    li.textContent = `${a.student_id}${sTxt}${hrs}${cmt}`;
    aUL.appendChild(li);
  });

  const sUL = document.getElementById("mSignups");
  sUL.innerHTML = "";
  sAcc.forEach(s => {
    const li = document.createElement("li");
    const hrs = (Number(s.requested_hours ?? s.hours_requested ?? 0) > 0) ? ` Â· Hours: ${s.requested_hours ?? s.hours_requested}` : "";
    const cmt = (s.comment || s.comments) ? ` â€” ${(s.comment || s.comments)}` : "";
    const sid = String(s.shift_id ?? s.shiftId ?? "").trim();
    const sLab = sid ? (shiftLabelById.get(sid) || sid) : "";
    const sTxt = sLab ? ` Â· Shift: ${sLab}` : "";
    li.textContent = `${s.student_id}${sTxt}${hrs}${cmt}`;
    sUL.appendChild(li);
  });

  const wHdr = document.getElementById("waitHdr");
  const wUL = document.getElementById("mWait");
  wUL.innerHTML = "";
  if (sWait.length){
    wHdr.style.display = "block";
    sWait.forEach(s => {
      const li = document.createElement("li");
      const hrs = (Number(s.requested_hours ?? s.hours_requested ?? 0) > 0) ? ` Â· Hours: ${s.requested_hours ?? s.hours_requested}` : "";
      const cmt = (s.comment || s.comments) ? ` â€” ${(s.comment || s.comments)}` : "";
      const sid = String(s.shift_id ?? s.shiftId ?? "").trim();
      const sLab = sid ? (shiftLabelById.get(sid) || sid) : "";
      const sTxt = sLab ? ` Â· Shift: ${sLab}` : "";
      li.textContent = `${s.student_id}${sTxt}${hrs}${cmt}`;
      wUL.appendChild(li);
    });
  } else {
    wHdr.style.display = "none";
  }

  document.getElementById("eventModal").style.display = "flex";

  document.getElementById("loadToFormBtn").onclick = async () => {
    document.getElementById('ev_id').value    = ev.event_id || '';
    document.getElementById('ev_title').value = ev.title || '';
    document.getElementById('ev_cat').value   = ev.category || ev.type || 'Events';
    document.getElementById('ev_start').value = ev.start ? toLocalInput(ev.start) : '';
    document.getElementById('ev_end').value   = ev.end ? toLocalInput(ev.end) : '';
    document.getElementById('ev_loc').value   = ev.location || '';
    document.getElementById('ev_hours').value = ev.hours_value != null ? ev.hours_value : 0;
    document.getElementById('ev_cap').value   = ev.signup_capacity != null ? ev.signup_capacity : 0;
    document.getElementById('ev_notes').value = ev.notes || ev.description || '';

    try{
      const shifts = await loadShiftsForEvent(ev.event_id || ev.id || "");
      const required = isTrue(ev?.shifts_required);
      setShiftEditorFromEvent(ev.event_id || ev.id || "", shifts, required);
    }catch(_){
      setShiftEditorFromEvent(ev.event_id || ev.id || "", [], isTrue(ev?.shifts_required));
    }

    closeModal();
    document.getElementById('eventForm')?.scrollIntoView({behavior:'smooth',block:'start'});
  };
}
function closeModal(){ document.getElementById("eventModal").style.display = "none"; }
document.getElementById("mClose").addEventListener("click", closeModal);
document.getElementById("closeBtn").addEventListener("click", closeModal);

function modalSelectedShift(){
  const wrap = document.getElementById("mShiftWrap");
  const sel  = document.getElementById("mShift");
  if (!wrap || wrap.style.display === "none" || !sel) return null;
  return String(sel.value || "").trim() || null;
}

async function modalSignupMe(eventId){
  const st = document.getElementById("mMyStatus");
  if (!eventId){ st.textContent = "No event id."; return; }

  const shiftId = modalSelectedShift();
  if (mustPickShiftForEvent(eventId) && !shiftId){
    st.textContent = "Pick a shift.";
    showPopup(false, "Missing shift", "This event requires a shift selection.");
    return;
  }

  st.textContent = "Submittingâ€¦";

  const requestedHours = safeHours(document.getElementById("mMyHours").value);
  const comment = (document.getElementById("mMyComment").value || "").trim();

  const out = await POST_tryActions(
    ["signup","event_signup","sign_up","submitSignup","submit_signup","newsignup","new_signup"],
    {
      student_id: currentAdminId,
      event_id: eventId,
      shift_id: shiftId,
      created_by: "admin",
      requested_hours: requestedHours,
      comment,
      notify: true,
      source: "portal_admin",
      current_semester: CURRENT_SEMESTER
    }
  );

  if (out && out.ok){
    openConfetti(
      "Signed up",
      requestedHours == null
        ? "You have been added to the sign-up list."
        : `You have been added to the sign-up list.\nRequested hours: ${requestedHours}`
    );
    st.textContent = "Done.";
    try{ document.getElementById("pcRefresh")?.click(); }catch(_){}
    await refreshMe();
  } else {
    const err = (out && (out.error || out.message)) || "Sign-up failed";
    showPopup(false, "Sign-up failed", err);
    st.textContent = "Failed.";
    if (out && out.body) console.log("POST body:", out.body);
  }
}

async function modalRequestMe(eventId){
  const st = document.getElementById("mMyStatus");
  if (!eventId){ st.textContent = "No event id."; return; }

  const shiftId = modalSelectedShift();
  if (mustPickShiftForEvent(eventId) && !shiftId){
    st.textContent = "Pick a shift.";
    showPopup(false, "Missing shift", "This event requires a shift selection.");
    return;
  }

  st.textContent = "Submittingâ€¦";

  const requestedHours = safeHours(document.getElementById("mMyHours").value);
  const comment = (document.getElementById("mMyComment").value || "").trim();

  const out = await POST_tryActions(
    ["request","attendance_request","submitrequest","submit_request","newrequest","new_request"],
    {
      student_id: currentAdminId,
      event_id: eventId,
      shift_id: shiftId,
      requested_hours: requestedHours,
      comment,
      notify: true,
      source: "portal_admin",
      current_semester: CURRENT_SEMESTER
    }
  );

  if (out && out.ok){
    openConfetti(
      "Request submitted",
      requestedHours == null
        ? "Your attendance request was submitted."
        : `Your attendance request was submitted.\nRequested hours: ${requestedHours}`
    );
    st.textContent = "Done.";
    try{ document.getElementById("pcRefresh")?.click(); }catch(_){}
    await refreshMe();
  } else {
    const err = (out && (out.error || out.message)) || "Request failed";
    showPopup(false, "Request failed", err);
    st.textContent = "Failed.";
    if (out && out.body) console.log("POST body:", out.body);
  }
}

/* ===== Save Event ===== */
async function saveEvent(){
  const msgEl = document.getElementById('evMsg');
  function setMsg(ok, text){ msgEl.className = "msg " + (ok ? "ok" : "err"); msgEl.textContent = text || ""; }

  const shiftPack = readShiftEditor(); // {enabled, required, shifts, removeAll}

  const payload = {
  event_id: (document.getElementById('ev_id').value || '').trim(),
  title: (document.getElementById('ev_title').value || '').trim(),
  category: document.getElementById('ev_cat').value || 'Events',
  start: document.getElementById('ev_start').value || '',
  end: document.getElementById('ev_end').value || '',
  location: (document.getElementById('ev_loc').value || '').trim(),
  hours_value: Number(document.getElementById('ev_hours').value || 0),
  signup_capacity: Number(document.getElementById('ev_cap').value || 0),
  notes: (document.getElementById('ev_notes').value || '').trim(),
  active: true,

  /* ===== SHIFTS (sent ONLY via upsertevent) ===== */
  shifts_enabled: !!shiftPack.enabled,
  shifts_required: shiftPack.enabled ? !!shiftPack.required : false,
  shifts_remove_all: !!shiftPack.removeAll,
  shifts: Array.isArray(shiftPack.shifts) ? shiftPack.shifts : [],

  notify: true,
  source: "portal_admin",
  current_semester: CURRENT_SEMESTER
};

if (!payload.event_id || !payload.title || !payload.start){
  setMsg(false, "Please fill Event ID, Title, and Start.");
  showPopup(false, "Save failed", "Please fill Event ID, Title, and Start.");
  return;
}

if (payload.end && new Date(payload.end) < new Date(payload.start)){
  setMsg(false, "End time cannot be before Start.");
  showPopup(false, "Save failed", "End time cannot be before Start.");
  return;
}


  setMsg(true, "Savingâ€¦");

  /* Try multiple event upsert action names (prevents Unknown action) */
  const out = await POST_tryActions(
    ["upsertevent","upsert_event","saveevent","save_event","addevent","add_event","editevent","edit_event"],
    payload
  );

  if (!out.ok){
    const err = (out.error || out.message || "Save failed") + (out.body ? " (see console)" : "");
    setMsg(false, err);
    showPopup(false, "Save failed", err);
    if (out.body) console.log("POST body:", out.body);
    return;
  }

  /* Best-effort shift sync (if your Apps Script has separate shift endpoints) */
  try{
    if (shiftPack.enabled){
      if (shiftPack.removeAll){
        await POST_tryActions(["clearshifts","clear_shifts","delete_shifts","remove_shifts","shifts_clear"], {
          event_id: payload.event_id,
          source: "portal_admin"
        });
      } else if (shiftPack.shifts.length){
        await POST_tryActions(["upsertshifts","upsert_shifts","setshifts","set_shifts","save_shifts","shifts_upsert"], {
          event_id: payload.event_id,
          shifts_required: !!shiftPack.required,
          shifts: shiftPack.shifts,
          source: "portal_admin"
        });
      }
    } else if (shiftPack.removeAll){
      await POST_tryActions(["clearshifts","clear_shifts","delete_shifts","remove_shifts","shifts_clear"], {
        event_id: payload.event_id,
        source: "portal_admin"
      });
    }
  }catch(_){}

  setMsg(true, "Saved!");
  openConfetti("Event saved", "Your event was saved successfully.");

  const evResp = await GET({ action:"events" });
  eventsCache = Array.isArray(evResp) ? evResp : (evResp && Array.isArray(evResp.events) ? evResp.events : []);
  activeEventsCache = (eventsCache || []).filter(isActiveEvent);

  shiftsCacheByEvent.clear();
  shiftLabelById.clear();

  fillEventSelects(activeEventsCache);
  buildCalendar(activeEventsCache);

  setShiftUI("req", document.getElementById("reqEvent")?.value || "");
  setShiftUI("su", document.getElementById("signupEvent")?.value || "");

  try{ document.getElementById("pcRefresh")?.click(); }catch(_){}
  document.getElementById('eventForm').reset();
  clearShiftEditorUI();
  autofillEventIdIfEmpty();
}

/* ---- Helpers for Pending Center ---- */
function asArray(x){
  if (!x) return [];
  if (Array.isArray(x)) return x;
  if (Array.isArray(x.rows)) return x.rows;
  if (Array.isArray(x.data)) return x.data;
  return [];
}
function normalizePending(resp){
  if (!resp) return [];
  if (Array.isArray(resp.pending)) return resp.pending;
  if (Array.isArray(resp.pending_requests)) return resp.pending_requests;
  if (resp.requests){
    if (Array.isArray(resp.requests.pending)) return resp.requests.pending;
    if (Array.isArray(resp.requests)) return resp.requests;
  }
  if (resp.attendance){
    if (Array.isArray(resp.attendance.pending)) return resp.attendance.pending;
    if (Array.isArray(resp.attendance)) return resp.attendance;
  }
  return asArray(resp);
}
function isPendingRow(r){
  const s = String(
    r?.status ??
    r?.request_status ??
    r?.state ??
    r?.decision ??
    r?.approval_status ??
    ""
  ).trim().toLowerCase();

  const approvedFlag = r?.approved ?? r?.is_approved ?? r?.isApproved ?? null;
  const deniedFlag   = r?.denied ?? r?.is_denied ?? r?.isDenied ?? null;

  if (approvedFlag === true || deniedFlag === true) return false;

  if (!s) return true;
  if (s.includes("pending")) return true;
  if (s.includes("submitted")) return true;
  if (s.includes("await")) return true;
  if (s.includes("review")) return true;

  if (s.includes("approv")) return false;
  if (s.includes("deny")) return false;
  if (s.includes("reject")) return false;
  if (s.includes("cancel")) return false;

  return false;
}

function normCat(v){
  const s = String(v || "").trim();
  if (!s) return "";
  const t = s.toLowerCase();
  if (t.startsWith("social")) return "Socials";
  if (t.startsWith("event")) return "Events";
  if (t.startsWith("meeting")) return "Meetings";
  if (t.startsWith("deadline")) return "Deadlines";
  return s;
}
function getReqHours(row){
  const v = row?.requested_hours ?? row?.hours_requested ?? row?.hours ?? row?.requestedHours ?? "";
  return (v === null || v === undefined) ? "" : String(v);
}
function getReqComment(row){
  const v = row?.comment ?? row?.comments ?? row?.notes ?? "";
  return String(v || "");
}
function getReqStudent(row){
  return String(row?.student_id ?? row?.student ?? row?.email ?? row?.studentEmail ?? "");
}
function getReqEventId(row){
  return String(row?.event_id ?? row?.eventId ?? row?.event ?? "");
}
function findEventById(eventId){
  const id = String(eventId||"").trim();
  return (eventsCache || []).find(e => String(e.event_id||"").trim() === id) || null;
}

/* =========================
   PENDING CENTER (All Events)
   ========================= */
function initPendingCenter(activeEvents){
  const $ = (id)=>document.getElementById(id);

  const btnRefresh = $("pcRefresh");
  const statusEl   = $("pcStatus");
  const bodyEl     = $("pcBody");
  const searchEl   = $("pcSearch");
  const eventSel   = $("pcEvent");
  const catSel     = $("pcCat");
  const allBox     = $("pcAll");
  const btnApSel   = $("pcApproveSel");
  const btnDnSel   = $("pcDenySel");

  if (!btnRefresh || !statusEl || !bodyEl) return;

  (function fillEventFilter(){
    const prev = eventSel?.value || "";
    if (!eventSel) return;
    const list = [...(activeEvents||[])].sort((a,b)=>{
      const ta = Date.parse(a.start), tb = Date.parse(b.start);
      if (isNaN(ta) && isNaN(tb)) return 0;
      if (isNaN(ta)) return 1;
      if (isNaN(tb)) return -1;
      return tb - ta;
    });

    eventSel.innerHTML = `<option value="">All events</option>`;
    list.forEach(ev=>{
      const opt = document.createElement("option");
      opt.value = ev.event_id;
      opt.textContent = `${ev.title} â€” ${fmtDate(ev.start)}`;
      eventSel.appendChild(opt);
    });
    if (prev) eventSel.value = prev;
  })();

  let pendingRaw = [];
  let rendered = [];

  function setStatus(txt){ statusEl.textContent = txt || ""; }

  function currentFilters(){
    return {
      q: (searchEl?.value || "").trim().toLowerCase(),
      event_id: (eventSel?.value || "").trim(),
      cat: (catSel?.value || "").trim()
    };
  }

  async function renderTable(){
    const f = currentFilters();

    rendered = (pendingRaw || []).filter(r=>{
      const evId = getReqEventId(r);
      const ev = findEventById(evId);
      const cat = normCat(r.category || r.cat || r.event_category || ev?.category || ev?.type || "");
      const title = (r.event_title || ev?.title || "").toLowerCase();
      const student = getReqStudent(r).toLowerCase();
      const comment = getReqComment(r).toLowerCase();

      if (f.event_id && String(f.event_id) !== String(evId)) return false;
      if (f.cat && String(f.cat) !== String(cat)) return false;
      if (f.q){
        const hay = `${title} ${student} ${comment} ${evId}`.toLowerCase();
        if (!hay.includes(f.q)) return false;
      }
      return true;
    });

    setStatus(rendered.length ? `${rendered.length} pending request(s)` : `No pending requests`);

    bodyEl.innerHTML = rendered.map((r, idx)=>{
      const evId = getReqEventId(r);
      const ev = findEventById(evId);
      const title = r.event_title || ev?.title || evId || "â€”";
      const student = getReqStudent(r) || "â€”";
      const hours = getReqHours(r);
      const comment = getReqComment(r);
      const cat = normCat(r.category || r.cat || r.event_category || ev?.category || ev?.type || "");

      const sid = String(r.shift_id ?? r.shiftId ?? "").trim();
      const sLab = sid ? (shiftLabelById.get(sid) || sid) : "";
      const sTxt = sLab ? ` Â· shift: ${esc(sLab)}` : "";

      return `
        <tr data-idx="${idx}">
          <td><input class="pcChk" type="checkbox"></td>
          <td>
            <div style="font-weight:600;">${esc(title)}</div>
            <div class="muted small">${esc(cat)} Â· ${ev?.start ? esc(fmtShortDate(ev.start)) : ""}${sTxt}</div>
            <div class="muted small">${esc(evId)}</div>
          </td>
          <td>${esc(student)}</td>
          <td>${esc(hours || "")}</td>
          <td style="white-space:pre-wrap;">${esc(comment)}</td>
          <td style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="actBtn approve pcApproveOne" type="button">Approve</button>
            <button class="actBtn deny pcDenyOne" type="button">Deny</button>
          </td>
        </tr>
      `;
    }).join("");

    bodyEl.querySelectorAll(".pcApproveOne").forEach((b, i)=> b.addEventListener("click", ()=> approveOne(i)));
    bodyEl.querySelectorAll(".pcDenyOne").forEach((b, i)=> b.addEventListener("click", ()=> denyOne(i)));

    if (allBox) allBox.checked = false;
  }

  async function loadPending(){
    setStatus("Loadingâ€¦");
    bodyEl.innerHTML = "";

    const resp = await GET_tryActions(
      ["pending", "pendingRequests", "pending_requests", "requests_pending", "requests", "attendance_pending"],
      {}
    );

    if (resp && resp.ok === false && (resp.error || resp.message)){
      const err = resp.error || resp.message || "Failed to load pending requests";
      setStatus(err);
      return;
    }

    // normalize response into an array
    pendingRaw = normalizePending(resp) || [];

    // âœ… filter to ONLY pending rows
    pendingRaw = pendingRaw.filter(isPendingRow);

    const evIdsToPreload = new Set();
    pendingRaw.forEach(r=>{
      const evId = String(r.event_id ?? r.eventId ?? "").trim();
      if (evId) evIdsToPreload.add(evId);
    });
    for (const evId of evIdsToPreload){
      try{ await loadShiftsForEvent(evId); }catch(_){}
    }

    await renderTable();
  }

  function selectedIndexes(){
    const rows = [...bodyEl.querySelectorAll("tr")];
    const idxs = [];
    rows.forEach((tr, i)=>{
      const chk = tr.querySelector(".pcChk");
      if (chk && chk.checked) idxs.push(i);
    });
    return idxs;
  }

  /* FIX: Approve/Deny now try multiple action names to avoid Unknown action */
  async function doApprove(row){
    return POST_tryActions(
      ["approve","approve_request","approverequest","setrequestapproved","set_request_approved","request_approve","attendanceapprove","attendance_approve"],
      {
        student_id: getReqStudent(row),
        event_id: getReqEventId(row),
        shift_id: row.shift_id ?? row.shiftId ?? null,
        request_id: row.request_id ?? row.id ?? row.row_id ?? row._id ?? null,
        notify: true,
        source: "portal_admin",
        current_semester: CURRENT_SEMESTER
      }
    );
  }
  async function doDeny(row){
    return POST_tryActions(
      ["deny","deny_request","denyrequest","setrequestdenied","set_request_denied","request_deny","attendancedeny","attendance_deny"],
      {
        student_id: getReqStudent(row),
        event_id: getReqEventId(row),
        shift_id: row.shift_id ?? row.shiftId ?? null,
        request_id: row.request_id ?? row.id ?? row.row_id ?? row._id ?? null,
        notify: true,
        source: "portal_admin",
        current_semester: CURRENT_SEMESTER
      }
    );
  }

  async function approveOne(renderIdx){
    const row = rendered[renderIdx];
    if (!row) return;

    setStatus("Approvingâ€¦");
    const out = await doApprove(row);

    if (out && out.ok){
      openConfetti("Approved", "Request approved.");
      await loadPending();
      await refreshMe();
    } else {
      const err = (out && (out.error || out.message)) || "Approve failed";
      showPopup(false, "Approve failed", err);
      setStatus(err);
      if (out?.body) console.log("approve body:", out.body);
    }
  }

  async function denyOne(renderIdx){
    const row = rendered[renderIdx];
    if (!row) return;

    setStatus("Denyingâ€¦");
    const out = await doDeny(row);

    if (out && out.ok){
      openConfetti("Denied", "Request denied.");
      await loadPending();
      await refreshMe();
    } else {
      const err = (out && (out.error || out.message)) || "Deny failed";
      showPopup(false, "Deny failed", err);
      setStatus(err);
      if (out?.body) console.log("deny body:", out.body);
    }
  }

  async function approveSelected(){
    const idxs = selectedIndexes();
    if (!idxs.length){
      showPopup(false, "Nothing selected", "Select at least one request.");
      return;
    }
    setStatus(`Approving ${idxs.length}â€¦`);

    for (const i of idxs){
      const row = rendered[i];
      if (!row) continue;
      const out = await doApprove(row);
      if (!(out && out.ok)){
        const err = (out && (out.error || out.message)) || "Approve failed mid-batch";
        showPopup(false, "Batch approve stopped", err);
        setStatus(err);
        return;
      }
    }

    openConfetti("Approved", `${idxs.length} request(s) approved.`);
    await loadPending();
    await refreshMe();
  }

  async function denySelected(){
    const idxs = selectedIndexes();
    if (!idxs.length){
      showPopup(false, "Nothing selected", "Select at least one request.");
      return;
    }
    setStatus(`Denying ${idxs.length}â€¦`);

    for (const i of idxs){
      const row = rendered[i];
      if (!row) continue;
      const out = await doDeny(row);
      if (!(out && out.ok)){
        const err = (out && (out.error || out.message)) || "Deny failed mid-batch";
        showPopup(false, "Batch deny stopped", err);
        setStatus(err);
        return;
      }
    }

    openConfetti("Denied", `${idxs.length} request(s) denied.`);
    await loadPending();
    await refreshMe();
  }

  btnRefresh.onclick = loadPending;
  searchEl && searchEl.addEventListener("input", renderTable);
  eventSel && eventSel.addEventListener("change", renderTable);
  catSel && catSel.addEventListener("change", renderTable);

  allBox && allBox.addEventListener("change", ()=>{
    const on = allBox.checked;
    bodyEl.querySelectorAll(".pcChk").forEach(chk => chk.checked = on);
  });

  btnApSel && (btnApSel.onclick = approveSelected);
  btnDnSel && (btnDnSel.onclick = denySelected);

  loadPending();
}

/* =========================
   REQUIREMENTS (Admin)
   (unchanged from your version)
   ========================= */
async function initReqAdmin(){
  const elDL      = document.getElementById("rq_students");
  const elSearch = document.getElementById("rq_search");
  const elLoad    = document.getElementById("rq_load");
  const elList    = document.getElementById("rq_list");
  const elStatus = document.getElementById("rq_status");
  const elSel     = document.getElementById("rq_sel");
  const btnAll    = document.getElementById("rq_check_all");
  const btnNone   = document.getElementById("rq_uncheck_all");

  if (!elDL || !elSearch || !elLoad || !elList) return;

  const keys = Object.keys(REQUIREMENT_LABELS);

  let students = [];
  let current = null;

  function setStatus(t, isErr){
    if (!elStatus) return;
    elStatus.textContent = t || "";
    elStatus.className = isErr ? "err" : "muted small";
  }

  setStatus("Loading studentsâ€¦");
  const s = await GET({ action:"students" });

  const arr = Array.isArray(s) ? s : (s && Array.isArray(s.students) ? s.students : []);
  students = (arr || [])
    .map(x => ({
      student_id: (x.student_id || x.email || "").trim(),
      email: (x.email || "").trim(),
      name: (x.name || x.student_name || x.full_name || "").trim()
    }))
    .filter(x => x.student_id);

  elDL.innerHTML = students
    .map(st => `<option value="${esc(st.student_id)}">${esc(st.name || st.email || st.student_id)}</option>`)
    .join("");

  setStatus("Ready. Pick a student and click Load.");

  elLoad.onclick = async ()=>{
    const input = (elSearch.value || "").trim();
    if(!input) return setStatus("Enter or select a student email.", true);

    current = students.find(s => _norm(s.student_id) === _norm(input))
            || students.find(s => _norm(s.email) === _norm(input))
            || students.find(s => (s.name||"").toLowerCase().includes(input.toLowerCase()))
            || { student_id: input, email: input, name: "" };

    await loadStudent(current.student_id, current.name || current.email || "");
  };

  btnAll && (btnAll.onclick = ()=> bulkSet(true));
  btnNone && (btnNone.onclick = ()=> bulkSet(false));

  async function loadStudent(student_id, displayName){
    setStatus("Loading requirementsâ€¦");
    if (elSel){
      elSel.innerHTML = `<span class="rq-pill">${esc(student_id)}</span>${displayName ? " Â· "+esc(displayName) : ""}`;
    }

    const sum = await GET({ action:"studentsummary", student_id });

    if(!sum || sum.ok === false){
      return setStatus("Failed to load: " + ((sum && (sum.error || sum.message)) || "unknown"), true);
    }

    const rows = Array.isArray(sum.requirements) ? sum.requirements : [];
    const have = new Map(rows.map(r => [
      String(r.requirement_key ?? r.key ?? ""),
      (String(r.is_checked) === "true" || r.is_checked === true || String(r.is_checked).toLowerCase() === "yes" || r.is_checked === 1)
    ]));

    elList.innerHTML = keys.map(k=>{
      const checked = have.get(k) === true;
      const label = REQUIREMENT_LABELS[k] || k;
      return `
        <div class="rq-row" data-key="${esc(k)}">
          <label class="rq-lbl">
            <input type="checkbox" ${checked ? "checked" : ""} data-role="rq-cb">
            <span>${esc(label)}</span>
          </label>
          <div class="rq-meta">${checked ? "checked" : "unchecked"}</div>
        </div>`;
    }).join("");

    elList.querySelectorAll('input[type="checkbox"][data-role="rq-cb"]').forEach(cb=>{
      cb.addEventListener("change", async (ev)=>{
        const row = ev.target.closest(".rq-row");
        const key = row && row.getAttribute("data-key");
        if(!key) return;

        const desired = !!ev.target.checked;
        setStatus("Savingâ€¦");

        const out = await POST_tryActions(
          ["setrequirement","set_requirement","requirement_set","update_requirement"],
          {
            student_id,
            requirement_key: key,
            is_checked: desired,
            updated_by: "admin",
            notify: true,
            source: "portal_admin",
            current_semester: CURRENT_SEMESTER
          }
        );

        if(!out || !out.ok){
          ev.target.checked = !desired;
          const err = (out && (out.error || out.message)) || "Save failed";
          setStatus(`Save failed for "${key}": ${err}`, true);
          showPopup(false, "Save failed", `Could not update "${key}".\n${err}`);
          if (out && out.body) console.log("POST body:", out.body);
        } else {
          const meta = row.querySelector(".rq-meta");
          if (meta) meta.textContent = desired ? "checked" : "unchecked";
          setStatus(`Saved "${key}" â†’ ${desired ? "checked" : "unchecked"}.`);
          openConfetti("Saved", `"${key}" was updated.`);
        }
      });
    });

    setStatus(`Loaded ${keys.length} items.`);
  }

  async function bulkSet(val){
    if(!current) return setStatus("Load a student first.", true);

    const boxes = elList.querySelectorAll('input[type="checkbox"][data-role="rq-cb"]');
    let okCount=0, failCount=0;

    setStatus("Bulk savingâ€¦");

    for (const cb of boxes){
      const row = cb.closest(".rq-row");
      const key = row && row.getAttribute("data-key");
      if(!key) continue;

      if ((cb.checked ? true : false) === val) continue;

      cb.checked = val;

      const out = await POST_tryActions(
        ["setrequirement","set_requirement","requirement_set","update_requirement"],
        {
          student_id: current.student_id,
          requirement_key: key,
          is_checked: val,
          updated_by: "admin",
          notify: true,
          source: "portal_admin",
          current_semester: CURRENT_SEMESTER
        }
      );

      if(!out || !out.ok){
        cb.checked = !val;
        failCount++;
        if (out && out.body) console.log("POST body:", out.body);
      } else {
        okCount++;
        const meta = row.querySelector(".rq-meta");
        if (meta) meta.textContent = val ? "checked" : "unchecked";
      }
    }

    setStatus(`Bulk saved: ${okCount} ok${failCount ? `, ${failCount} failed` : ""}`, !!failCount);
    if (okCount && failCount === 0){
      openConfetti("Bulk update", `Updated ${okCount} item(s).`);
    } else {
      showPopup(failCount === 0, "Bulk update", `Updated ${okCount} item(s).${failCount ? `\nFailed: ${failCount}` : ""}`);
    }
  }
}
</script>
